"use strict";(self.webpackChunkorca_website=self.webpackChunkorca_website||[]).push([[7570],{3905:(e,t,a)=>{a.d(t,{Zo:()=>s,kt:()=>k});var n=a(7294);function r(e,t,a){return t in e?Object.defineProperty(e,t,{value:a,enumerable:!0,configurable:!0,writable:!0}):e[t]=a,e}function l(e,t){var a=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),a.push.apply(a,n)}return a}function o(e){for(var t=1;t<arguments.length;t++){var a=null!=arguments[t]?arguments[t]:{};t%2?l(Object(a),!0).forEach((function(t){r(e,t,a[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(a)):l(Object(a)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(a,t))}))}return e}function i(e,t){if(null==e)return{};var a,n,r=function(e,t){if(null==e)return{};var a,n,r={},l=Object.keys(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||(r[a]=e[a]);return r}(e,t);if(Object.getOwnPropertySymbols){var l=Object.getOwnPropertySymbols(e);for(n=0;n<l.length;n++)a=l[n],t.indexOf(a)>=0||Object.prototype.propertyIsEnumerable.call(e,a)&&(r[a]=e[a])}return r}var u=n.createContext({}),d=function(e){var t=n.useContext(u),a=t;return e&&(a="function"==typeof e?e(t):o(o({},t),e)),a},s=function(e){var t=d(e.components);return n.createElement(u.Provider,{value:t},e.children)},m="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return n.createElement(n.Fragment,{},t)}},c=n.forwardRef((function(e,t){var a=e.components,r=e.mdxType,l=e.originalType,u=e.parentName,s=i(e,["components","mdxType","originalType","parentName"]),m=d(a),c=r,k=m["".concat(u,".").concat(c)]||m[c]||p[c]||l;return a?n.createElement(k,o(o({ref:t},s),{},{components:a})):n.createElement(k,o({ref:t},s))}));function k(e,t){var a=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var l=a.length,o=new Array(l);o[0]=c;var i={};for(var u in t)hasOwnProperty.call(t,u)&&(i[u]=t[u]);i.originalType=e,i[m]="string"==typeof e?e:r,o[1]=i;for(var d=2;d<l;d++)o[d]=a[d];return n.createElement.apply(null,o)}return n.createElement.apply(null,a)}c.displayName="MDXCreateElement"},6785:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>u,contentTitle:()=>o,default:()=>p,frontMatter:()=>l,metadata:()=>i,toc:()=>d});var n=a(7462),r=(a(7294),a(3905));const l={id:"deployment-with-cumulus",title:"Deploying ORCA with Cumulus",description:"Provides developer information for ORCA code deployment with Cumulus."},o=void 0,i={unversionedId:"developer/deployment-guide/deployment-with-cumulus",id:"developer/deployment-guide/deployment-with-cumulus",title:"Deploying ORCA with Cumulus",description:"Provides developer information for ORCA code deployment with Cumulus.",source:"@site/docs/developer/deployment-guide/deployment-with-cumulus.md",sourceDirName:"developer/deployment-guide",slug:"/developer/deployment-guide/deployment-with-cumulus",permalink:"/cumulus-orca/docs/developer/deployment-guide/deployment-with-cumulus",draft:!1,editUrl:"https://github.com/nasa/cumulus-orca/edit/develop/website/docs/developer/deployment-guide/deployment-with-cumulus.md",tags:[],version:"current",frontMatter:{id:"deployment-with-cumulus",title:"Deploying ORCA with Cumulus",description:"Provides developer information for ORCA code deployment with Cumulus."},sidebar:"dev_guide",previous:{title:"Generating S3 credentials",permalink:"/cumulus-orca/docs/developer/deployment-guide/deployment-s3-credentials"},next:{title:"Upgrading ORCA",permalink:"/cumulus-orca/docs/developer/deployment-guide/deployment-upgrading-orca"}},u={},d=[{value:"Configuring the ORCA Deployment",id:"configuring-the-orca-deployment",level:2},{value:"Creating <code>cumulus-tf/orca.tf</code>",id:"creating-cumulus-tforcatf",level:3},{value:"Required Values Unique to the ORCA Module",id:"required-values-unique-to-the-orca-module",level:4},{value:"Required Values Retrieved from Cumulus Variables",id:"required-values-retrieved-from-cumulus-variables",level:4},{value:"Required Values Retrieved from Other Modules",id:"required-values-retrieved-from-other-modules",level:4},{value:"Creating <code>cumulus-tf/orca_variables.tf</code>",id:"creating-cumulus-tforca_variablestf",level:3},{value:"Modifying <code>cumulus-tf/terraform.tfvars</code>",id:"modifying-cumulus-tfterraformtfvars",level:3},{value:"Define the ORCA Workflows",id:"define-the-orca-workflows",level:2},{value:"Add the Move Granule Step to an Ingest Workflow",id:"add-the-move-granule-step-to-an-ingest-workflow",level:3},{value:"Add the CopyToArchive Step to an Ingest Workflow",id:"add-the-copytoarchive-step-to-an-ingest-workflow",level:3},{value:"Modify the Recovery Workflow (<em>OPTIONAL</em>)",id:"modify-the-recovery-workflow-optional",level:3},{value:"Workflow Failures",id:"workflow-failures",level:3},{value:"ORCA Variables",id:"orca-variables",level:2},{value:"Required Variables",id:"required-variables",level:3},{value:"Cumulus Required Variables",id:"cumulus-required-variables",level:4},{value:"ORCA Required Variables",id:"orca-required-variables",level:4},{value:"Optional Variables",id:"optional-variables",level:3},{value:"Cumulus Optional Variables",id:"cumulus-optional-variables",level:4},{value:"ORCA Optional Variables",id:"orca-optional-variables",level:4},{value:"ORCA Module Outputs",id:"orca-module-outputs",level:2},{value:"Deploy ORCA with Terraform",id:"deploy-orca-with-terraform",level:2},{value:"Collection Configuration",id:"collection-configuration",level:2},{value:"Enable <code>Recover Granule</code> Button",id:"enable-recover-granule-button",level:2}],s={toc:d},m="wrapper";function p(e){let{components:t,...a}=e;return(0,r.kt)(m,(0,n.Z)({},s,a,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("admonition",{type:"important"},(0,r.kt)("p",{parentName:"admonition"},"Prior to following this document, make sure that your ",(0,r.kt)("a",{parentName:"p",href:"/cumulus-orca/docs/developer/deployment-guide/deployment-environment"},"deployment environment"),"\nis setup and an ",(0,r.kt)("a",{parentName:"p",href:"/cumulus-orca/docs/developer/deployment-guide/deployment-s3-bucket"},"ORCA archive bucket")," is\ncreated.")),(0,r.kt)("p",null,"ORCA is meant to be deployed with Cumulus. To deploy ORCA add and/or modify the\nfiles in the Cumulus ",(0,r.kt)("inlineCode",{parentName:"p"},"cumulus-tf")," deployment."),(0,r.kt)("p",null,"The general steps to deploy and use ORCA are:"),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"#configuring-the-orca-deployment"},"Configure the ORCA deployment.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"#define-the-orca-wokflows"},"Define the ORCA Ingest and Recovery workflows.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"#deploy-orca-with-terraform"},"Deploy ORCA using terraform.")),(0,r.kt)("li",{parentName:"ol"},(0,r.kt)("a",{parentName:"li",href:"#collection-configuration"},"Configure ORCA in the collection configuration of the running Cumulus instance."))),(0,r.kt)("h2",{id:"configuring-the-orca-deployment"},"Configuring the ORCA Deployment"),(0,r.kt)("p",null,"Follow the instructions for ",(0,r.kt)("a",{parentName:"p",href:"https://nasa.github.io/cumulus/docs/deployment/deployment-readme"},"deploying Cumulus"),"\non the Cumulus website through the configuration of the Cumulus module ",(0,r.kt)("inlineCode",{parentName:"p"},"cumulus-tf"),"."),(0,r.kt)("p",null,"Prior to deploying the ",(0,r.kt)("inlineCode",{parentName:"p"},"cumulus-tf")," module, the following files need to be added\nand/or modified to deploy ORCA with Cumulus."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"orca.tf"),(0,r.kt)("li",{parentName:"ul"},"orca_variables.tf"),(0,r.kt)("li",{parentName:"ul"},"terraform.tfvars"),(0,r.kt)("li",{parentName:"ul"},"main.tf")),(0,r.kt)("h3",{id:"creating-cumulus-tforcatf"},"Creating ",(0,r.kt)("inlineCode",{parentName:"h3"},"cumulus-tf/orca.tf")),(0,r.kt)("p",null,"Create the ",(0,r.kt)("inlineCode",{parentName:"p"},"orca.tf")," file in the ",(0,r.kt)("inlineCode",{parentName:"p"},"cumulus-tf")," directory and copy the code below\ninto the new ",(0,r.kt)("inlineCode",{parentName:"p"},"orca.tf")," file. Update the source variable with the preferred\nORCA version."),(0,r.kt)("admonition",{title:"Only change the value of source",type:"important"},(0,r.kt)("p",{parentName:"admonition"},"Only change the value of ",(0,r.kt)("inlineCode",{parentName:"p"},"source")," in the code example below to point to the\nproper ORCA version. The ORCA version is specified right after ",(0,r.kt)("em",{parentName:"p"},"download")," in the\nURL path to the release. In the example below the release being used is v3.0.2.")),(0,r.kt)("admonition",{title:"Deploying a local version",type:"tip"},(0,r.kt)("p",{parentName:"admonition"},"If you wish to deploy code cloned locally from ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/nasa/cumulus-orca"},"Github")," instead of a release zip, run\n",(0,r.kt)("inlineCode",{parentName:"p"},"./bin/build_tasks.sh"),". This will crawl the ",(0,r.kt)("inlineCode",{parentName:"p"},"tasks")," directory and build a ",(0,r.kt)("inlineCode",{parentName:"p"},".zip")," file (currently by just ",(0,r.kt)("inlineCode",{parentName:"p"},"zipping")," all python files and dependencies) in each of it's sub-directories. You may then set ",(0,r.kt)("inlineCode",{parentName:"p"},"source")," to the root folder of your cloned Orca repository.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-terraform"},'## ORCA Module\n## =============================================================================\nmodule "orca" {\n  source = "https://github.com/nasa/cumulus-orca/releases/download/v3.0.2/cumulus-orca-terraform.zip"\n  ## --------------------------\n  ## Cumulus Variables\n  ## --------------------------\n  ## REQUIRED\n  aws_region               = var.region\n  buckets                  = var.buckets\n  lambda_subnet_ids        = var.lambda_subnet_ids\n  permissions_boundary_arn = var.permissions_boundary_arn\n  prefix                   = var.prefix\n  system_bucket            = var.system_bucket\n  vpc_id                   = var.vpc_id\n  workflow_config          = module.cumulus.workflow_config\n\n  ## OPTIONAL\n  tags        = var.tags\n\n  ## --------------------------\n  ## ORCA Variables\n  ## --------------------------\n  ## REQUIRED\n  db_admin_password        = var.db_admin_password\n  db_host_endpoint         = var.db_host_endpoint\n  db_user_password         = var.db_user_password\n  dlq_subscription_email   = var.dlq_subscription_email\n  orca_default_bucket      = var.orca_default_bucket\n  orca_reports_bucket_name = var.orca_reports_bucket_name\n  rds_security_group_id    = var.rds_security_group_id\n\n  ## OPTIONAL\n  # archive_recovery_queue_message_retention_time_seconds = 777600\n  # db_admin_username                                     = "postgres"\n  # default_multipart_chunksize_mb                        = 250\n  # log_level                                             = "INFO"\n  # metadata_queue_message_retention_time                 = 777600\n  # orca_default_recovery_type                            = "Standard"\n  # orca_default_storage_class                            = "GLACIER"\n  # orca_delete_old_reconcile_jobs_frequency_cron         = "cron(0 0 ? * SUN *)"\n  # orca_ingest_lambda_memory_size                        = 2240\n  # orca_ingest_lambda_timeout                            = 600\n  # orca_internal_reconciliation_expiration_days          = 30\n  # orca_reconciliation_lambda_memory_size                = 128\n  # orca_reconciliation_lambda_timeout                    = 720\n  # orca_recovery_buckets                                 = []\n  # orca_recovery_complete_filter_prefix                  = ""\n  # orca_recovery_expiration_days                         = 5\n  # orca_recovery_lambda_memory_size                      = 128\n  # orca_recovery_lambda_timeout                          = 720\n  # orca_recovery_retry_limit                             = 3\n  # orca_recovery_retry_interval                          = 1\n  # orca_recovery_retry_backoff                           = 2\n  # s3_inventory_queue_message_retention_time_seconds     = 432000\n  # s3_report_frequency                                   = "Daily"\n  # sqs_delay_time_seconds                                = 0\n  # sqs_maximum_message_size                              = 262144\n  # staged_recovery_queue_message_retention_time_seconds  = 432000\n  # status_update_queue_message_retention_time_seconds    = 777600\n\n\n}\n')),(0,r.kt)("h4",{id:"required-values-unique-to-the-orca-module"},"Required Values Unique to the ORCA Module"),(0,r.kt)("p",null,"The following variables are unique to the ORCA module and required to be set by\nthe user. More information about these required variables, as well as the\noptional variables can be found in the ",(0,r.kt)("a",{parentName:"p",href:"#orca-variables"},"variables section"),"."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"db_admin_password"),(0,r.kt)("li",{parentName:"ul"},"orca_default_bucket"),(0,r.kt)("li",{parentName:"ul"},"orca_reports_bucket_name"),(0,r.kt)("li",{parentName:"ul"},"db_user_password"),(0,r.kt)("li",{parentName:"ul"},"db_host_endpoint"),(0,r.kt)("li",{parentName:"ul"},"rds_security_group_id"),(0,r.kt)("li",{parentName:"ul"},"dlq_subscription_email")),(0,r.kt)("h4",{id:"required-values-retrieved-from-cumulus-variables"},"Required Values Retrieved from Cumulus Variables"),(0,r.kt)("p",null,"The following variables are set as part of your Cumulus deployment and are\nrequired by the ORCA module. More information about setting these variables can\nbe found in the ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/nasa/cumulus/blob/master/tf-modules/cumulus/variables.tf"},"Cumulus variable definitions"),".\nThe variables must be set with the proper values in the ",(0,r.kt)("inlineCode",{parentName:"p"},"terraform.tfvars")," file."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"buckets"),(0,r.kt)("li",{parentName:"ul"},"lambda_subnet_ids"),(0,r.kt)("li",{parentName:"ul"},"permissions_boundary_arn"),(0,r.kt)("li",{parentName:"ul"},"prefix"),(0,r.kt)("li",{parentName:"ul"},"system_bucket"),(0,r.kt)("li",{parentName:"ul"},"vpc_id")),(0,r.kt)("admonition",{title:"Optional Cumulus Values",type:"note"},(0,r.kt)("p",{parentName:"admonition"},"The ",(0,r.kt)("inlineCode",{parentName:"p"},"tags")," value automatically adds a ",(0,r.kt)("em",{parentName:"p"},"Deployment")," tag like the Cumulus\ndeployment.")),(0,r.kt)("h4",{id:"required-values-retrieved-from-other-modules"},"Required Values Retrieved from Other Modules"),(0,r.kt)("p",null,"The following variables are set by retrieving output from other modules. This is\ndone so that the user does not have to lookup and set these variables after a\ndeployment. More information about these variables can be found in the\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/nasa/cumulus/blob/master/tf-modules/cumulus/variables.tf"},"Cumulus variable definitions"),"."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},"workflow_config - Retrieved from the cumulus module in ",(0,r.kt)("inlineCode",{parentName:"li"},"main.tf"),".")),(0,r.kt)("h3",{id:"creating-cumulus-tforca_variablestf"},"Creating ",(0,r.kt)("inlineCode",{parentName:"h3"},"cumulus-tf/orca_variables.tf")),(0,r.kt)("p",null,"In the ",(0,r.kt)("inlineCode",{parentName:"p"},"cumulus-tf")," directory create the ",(0,r.kt)("inlineCode",{parentName:"p"},"orca_variables.tf")," file. Copy the\ncontents below into the file so that the ORCA unique variables are defined.\nFor more information on the variables, see the ",(0,r.kt)("a",{parentName:"p",href:"#orca-variables"},"variables section"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-terraform"},'## Variables unique to ORCA\n## REQUIRED\nvariable "db_admin_password" {\n  description = "Password for RDS database administrator authentication"\n  type        = string\n}\n\nvariable "db_user_password" {\n  description = "Password for RDS database user authentication"\n  type        = string\n}\n\nvariable "db_host_endpoint" {\n  type        = string\n  description = "Database host endpoint to connect to."\n}\n\nvariable "dlq_subscription_email" {\n  type        = string\n  description = "The email to notify users when messages are received in dead letter SQS queue due to restore failure. Sends one email until the dead letter queue is emptied."\n}\n\nvariable "orca_default_bucket" {\n  type        = string\n  description = "Default archive bucket to use."\n}\n\nvariable "orca_reports_bucket_name" {\n  type        = string\n  description = "The name of the bucket to store s3 inventory reports."\n}\n\nvariable "rds_security_group_id" {\n  type        = string\n  description = "Cumulus\' RDS Security Group\'s ID."\n}\n')),(0,r.kt)("h3",{id:"modifying-cumulus-tfterraformtfvars"},"Modifying ",(0,r.kt)("inlineCode",{parentName:"h3"},"cumulus-tf/terraform.tfvars")),(0,r.kt)("p",null,"At the end of the ",(0,r.kt)("inlineCode",{parentName:"p"},"terraform.tfvars")," file, add the following code. Update the\nrequired and optional variable values to the values needed for your particular\nenvironment."),(0,r.kt)("admonition",{type:"note"},(0,r.kt)("p",{parentName:"admonition"},"The example below shows the minimum variables to set for the module and accepting\ndefault values for all of the optional items. The ",(0,r.kt)("a",{parentName:"p",href:"#orca-variables"},"ORCA variables section"),"\nprovides additional information on variables that can be set for the ORCA application.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-terraform"},'## =============================================================================\n## ORCA Variables\n## =============================================================================\n\n## REQUIRED TO BE SET\n## -----------------------------------------------------------------------------\n\n## ORCA application database user password.\ndb_user_password = "my-super-secret-orca-application-user-password"\n\n## Default archive bucket to use\norca_default_bucket = "orca-archive-primary"\n\n## The name of the bucket to store s3 inventory reports.\norca_reports_bucket_name = "PREFIX-orca-reports"\n\n## PostgreSQL database (root) user password\ndb_admin_password = "my-super-secret-database-owner-password"\n\n## PostgreSQL database host endpoint to connect to.\ndb_host_endpoint = "aws.postgresrds.host"\n\n## Cumulus\' RDS Security Group\'s ID.\nrds_security_group_id = "sg-01234567890123456"\n\n## Dead letter queue SNS topic subscription email.\ndlq_subscription_email = "test@email.com"\n')),(0,r.kt)("p",null,"Below describes the type of value expected for each variable."),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"db_user_password")," (string) - the password for the application user."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"orca_default_bucket")," (string) - default S3 archive bucket to use for ORCA data."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"db_admin_password")," (string) - password for the admin user."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"db_host_endpoint"),"(string) - Database host endpoint to connect to."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"db_user_password")," (string) - the password for the application user."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"dlq_subscription_email"),'(string) - "The email to notify users when messages are received in dead letter SQS queue due to restore failure. Sends one email until the dead letter queue is emptied."'),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"orca_default_bucket")," (string) - Default S3 archive bucket to use for ORCA data."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"orca_reports_bucket_name")," (string) - The name of the bucket to store s3 inventory reports."),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("inlineCode",{parentName:"li"},"rds_security_group_id"),"(string) - Cumulus' RDS Security Group's ID. Output as ",(0,r.kt)("inlineCode",{parentName:"li"},"security_group_id")," from the rds-cluster deployment.")),(0,r.kt)("p",null,"Additional variable definitions can be found in the ",(0,r.kt)("a",{parentName:"p",href:"#orca-variables"},"ORCA variables"),"\nsection of the document."),(0,r.kt)("admonition",{type:"important"},(0,r.kt)("p",{parentName:"admonition"},"The cumulus ",(0,r.kt)("inlineCode",{parentName:"p"},"buckets")," variable will have to be modified to include the\ndisaster recovery buckets with a ",(0,r.kt)("em",{parentName:"p"},"type")," of ",(0,r.kt)("strong",{parentName:"p"},"orca"),". An example can be seen below.\nThis addition is required for ORCA to have the proper bucket permissions to\nwork with Cumulus."),(0,r.kt)("pre",{parentName:"admonition"},(0,r.kt)("code",{parentName:"pre",className:"language-terraform"},'buckets = {\n  orca_default = {\n    name = "orca-archive-primary"\n    type = "orca"\n  },\n  internal = {\n    name = "orca-internal"\n    type = "internal"\n  },\n  private = {\n    name = "orca-private"\n    type = "private"\n  },\n  protected = {\n    name = "orca-protected"\n    type = "protected"\n  },\n  public = {\n    name = "orca-public"\n    type = "public"\n  }\n}\n'))),(0,r.kt)("h2",{id:"define-the-orca-workflows"},"Define the ORCA Workflows"),(0,r.kt)("p",null,"The ORCA Ingest Workflows follows each step listed below. Adding the\nMoveGranuleStep and the CopyToArchive Step are detailed in their respective\nsections."),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"ORCA Ingest Workflow"),"\nSyncGranule\nFilesToGranuleStep\nMoveGranuleStep\nCopyToArchive"),(0,r.kt)("h3",{id:"add-the-move-granule-step-to-an-ingest-workflow"},"Add the Move Granule Step to an Ingest Workflow"),(0,r.kt)("p",null,"Navigate to ",(0,r.kt)("inlineCode",{parentName:"p"},"cumulus-tf/ingest_granule_workflow.tf")," then add the following\nstep anywhere after the FilesToGranuleStep step being sure to change the\nFilesToGranuleStep's ",(0,r.kt)("inlineCode",{parentName:"p"},'"Next"'),' parameter equal to "MoveGranuleStep".'),(0,r.kt)("admonition",{type:"important"},(0,r.kt)("p",{parentName:"admonition"},"Adjust the ",(0,r.kt)("inlineCode",{parentName:"p"},'"Next"')," step in the example below to point to the proper step in\nthe ingest workflow.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'"MoveGranuleStep": {\n      "Parameters": {\n        "cma": {\n          "event.$": "$",\n          "task_config": {\n            "bucket": "{$.meta.buckets.internal.name}",\n            "buckets": "{$.meta.buckets}",\n            "distribution_endpoint": "{$.meta.distribution_endpoint}",\n            "collection": "{$.meta.collection}",\n            "duplicateHandling": "{$.meta.collection.duplicateHandling}",\n            "s3MultipartChunksizeMb": "{$.meta.collection.meta.s3MultipartChunksizeMb}",\n            "cumulus_message": {\n              "outputs": [\n                { "source": "{$}", "destination": "{$.payload}" },\n                { "source": "{$.granules}", "destination": "{$.meta.processed_granules}" }\n              ]\n            }\n          }\n        }\n      },\n      "Type": "Task",\n      "Resource": "${move_granules_task_arn}",\n      "Retry": [\n        {\n          "ErrorEquals": [\n            "Lambda.ServiceException",\n            "Lambda.AWSLambdaException",\n            "Lambda.SdkClientException"\n          ],\n          "IntervalSeconds": 2,\n          "MaxAttempts": 6,\n          "BackoffRate": 2\n        }\n      ],\n      "Catch": [\n        {\n          "ErrorEquals": [\n            "States.ALL"\n          ],\n          "ResultPath": "$.exception",\n          "Next": "WorkflowFailed"\n        }\n      ],\n')),(0,r.kt)("h3",{id:"add-the-copytoarchive-step-to-an-ingest-workflow"},"Add the CopyToArchive Step to an Ingest Workflow"),(0,r.kt)("p",null,"Navigate to ",(0,r.kt)("inlineCode",{parentName:"p"},"cumulus-tf/ingest_granule_workflow.tf")," then add the following step\nanywhere after the MoveGranuleStep step being sure to change the MoveGranuleStep's\n",(0,r.kt)("inlineCode",{parentName:"p"},'"Next"'),' parameter equal to "CopyToArchive".'),(0,r.kt)("admonition",{type:"important"},(0,r.kt)("p",{parentName:"admonition"},"Adjust the ",(0,r.kt)("inlineCode",{parentName:"p"},'"Next"')," step in the example below to point to the proper step in\nthe ingest workflow.")),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'"CopyToArchive":{\n  "Parameters":{\n    "cma":{\n      "event.$":"$",\n      "task_config": {\n        "excludedFileExtensions": "{$.meta.collection.meta.orca.excludedFileExtensions}",\n        "s3MultipartChunksizeMb": "{$.meta.collection.meta.s3MultipartChunksizeMb}",\n        "providerId": "{$.meta.provider.id}",\n        "providerName": "{$.meta.provider.name}",\n        "executionId": "{$.cumulus_meta.execution_name}",\n        "collectionShortname": "{$.meta.collection.name}",\n        "collectionVersion": "{$.meta.collection.version}",\n        "defaultBucketOverride": "{$.meta.collection.meta.orca.defaultBucketOverride}"\n      }\n    }\n  }\n},\n  "Type":"Task",\n  "Resource":"module.orca.orca_lambda_copy_to_archive_arn",\n  "Catch":[\n    {\n      "ErrorEquals":[\n        "States.ALL"\n      ],\n      "ResultPath":"$.exception",\n      "Next":"WorkflowFailed"\n    }\n  ],\n  "Retry": [\n    {\n      "ErrorEquals": [\n        "States.ALL"\n      ],\n      "IntervalSeconds": 2,\n      "MaxAttempts": 3,\n      "BackoffRate": 2\n    }\n  ],\n  "Next":"WorkflowSucceeded"\n},\n')),(0,r.kt)("p",null,"See the copy_to_archive json schema ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/nasa/cumulus-orca/blob/master/tasks/copy_to_archive/schemas/config.json"},"configuration file"),", ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/nasa/cumulus-orca/blob/master/tasks/copy_to_archive/schemas/input.json"},"input file"),"  and ",(0,r.kt)("a",{parentName:"p",href:"https://github.com/nasa/cumulus-orca/blob/master/tasks/copy_to_archive/schemas/output.json"},"output file")," for more information."),(0,r.kt)("h3",{id:"modify-the-recovery-workflow-optional"},"Modify the Recovery Workflow (",(0,r.kt)("em",{parentName:"h3"},"OPTIONAL"),")"),(0,r.kt)("p",null,"It is not recommended to modify the ORCA Recovery Workflow. The workflow JSON\nfile is located in the ",(0,r.kt)("inlineCode",{parentName:"p"},"modules/workflows/OrcaRecoveryWorkflow")," of the repository.\nThe workflow file name is ",(0,r.kt)("inlineCode",{parentName:"p"},"orca_recover_workflow.asl.json"),". To change the\nbehavior of the workflow, it is recommended to modify or replace the\n",(0,r.kt)("inlineCode",{parentName:"p"},"copy_from_archive")," lambda."),(0,r.kt)("h3",{id:"workflow-failures"},"Workflow Failures"),(0,r.kt)("p",null,"Failures within ORCA break through to the Cumulus workflow they are a part\nof. More information on addressing workflow failures can be found on the\nORCA ",(0,r.kt)("a",{parentName:"p",href:"/cumulus-orca/docs/developer/development-guide/code/best-practices"},"Best Practices"),"\npage."),(0,r.kt)("h2",{id:"orca-variables"},"ORCA Variables"),(0,r.kt)("p",null,"The following sections detail the variables used by the ORCA module."),(0,r.kt)("h3",{id:"required-variables"},"Required Variables"),(0,r.kt)("p",null,"The following variables are required for the ORCA module and must be set to valid\nvalues."),(0,r.kt)("h4",{id:"cumulus-required-variables"},"Cumulus Required Variables"),(0,r.kt)("p",null,"The following variables should be present already in the ",(0,r.kt)("inlineCode",{parentName:"p"},"cumulus-tf/terraform.tfvars"),"\nfile. The variables must be set with proper values for your environment in the\n",(0,r.kt)("inlineCode",{parentName:"p"},"cumulus-tf/terraform.tfvars")," file."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Variable"),(0,r.kt)("th",{parentName:"tr",align:null},"Definition"),(0,r.kt)("th",{parentName:"tr",align:null},"Example Value"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"buckets")),(0,r.kt)("td",{parentName:"tr",align:null},"Mapping of all S3 buckets used by Cumulus and ORCA that contains a S3 ",(0,r.kt)("inlineCode",{parentName:"td"},"name")," and ",(0,r.kt)("inlineCode",{parentName:"td"},"type"),". A bucket with a ",(0,r.kt)("inlineCode",{parentName:"td"},"type")," of ",(0,r.kt)("strong",{parentName:"td"},"orca")," is required."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},'buckets = { orca_default = { name = "PREFIX-orca-primary", type = "orca", ...}}'))),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"lambda_subnet_ids")),(0,r.kt)("td",{parentName:"tr",align:null},"A list of subnets that the Lambda's and the database have access to for working with Cumulus."),(0,r.kt)("td",{parentName:"tr",align:null},'["subnet-12345", "subnet-abc123"]')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"permissions_boundary_arn")),(0,r.kt)("td",{parentName:"tr",align:null},"AWS ARN value of the permission boundary for the VPC account."),(0,r.kt)("td",{parentName:"tr",align:null},'"arn:aws:iam::1234567890:policy/NGAPShRoleBoundary"')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"prefix")),(0,r.kt)("td",{parentName:"tr",align:null},"Prefix that will be pre-pended to resource names created by terraform."),(0,r.kt)("td",{parentName:"tr",align:null},'"daac-sndbx"')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"system_bucket")),(0,r.kt)("td",{parentName:"tr",align:null},"Cumulus system bucket used to store internal files and configurations for deployments."),(0,r.kt)("td",{parentName:"tr",align:null},'"PREFIX-internal"')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"vpc_id")),(0,r.kt)("td",{parentName:"tr",align:null},"ID of VPC to place resources in - recommended that this be a private VPC (or at least one with restricted access)."),(0,r.kt)("td",{parentName:"tr",align:null},'"vpc-abc123456789"')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"workflow_config")),(0,r.kt)("td",{parentName:"tr",align:null},"Configuration object with ARNs for workflow integration (Role ARN for executing workflows and Lambda ARNs to trigger on workflow execution)."),(0,r.kt)("td",{parentName:"tr",align:null},"module.cumulus.workflow_config")))),(0,r.kt)("h4",{id:"orca-required-variables"},"ORCA Required Variables"),(0,r.kt)("p",null,"The following variables should be present in the ",(0,r.kt)("inlineCode",{parentName:"p"},"cumulus-tf/orca_variables.tf"),"\nfile. The variables must be set with proper values for your environment in the\n",(0,r.kt)("inlineCode",{parentName:"p"},"cumulus-tf/terraform.tfvars")," file."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Variable"),(0,r.kt)("th",{parentName:"tr",align:null},"Definition"),(0,r.kt)("th",{parentName:"tr",align:null},"Example Value"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"aws_region")),(0,r.kt)("td",{parentName:"tr",align:null},"AWS Region to create resources in."),(0,r.kt)("td",{parentName:"tr",align:null},'"us-west-2"')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"db_admin_password")),(0,r.kt)("td",{parentName:"tr",align:null},"Password for RDS database administrator authentication"),(0,r.kt)("td",{parentName:"tr",align:null},'"My_Sup3rS3cr3t_admin_Passw0rd"')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"db_host_endpoint")),(0,r.kt)("td",{parentName:"tr",align:null},"Database host endpoint to connect to."),(0,r.kt)("td",{parentName:"tr",align:null},'"aws.postgresrds.host"')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"db_user_password")),(0,r.kt)("td",{parentName:"tr",align:null},"Password for RDS database user authentication"),(0,r.kt)("td",{parentName:"tr",align:null},'"My_Sup3rS3cr3tuserPassw0rd"')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"dlq_subscription_email")),(0,r.kt)("td",{parentName:"tr",align:null},"The email to notify users when messages are received in dead letter SQS queue"),(0,r.kt)("td",{parentName:"tr",align:null},'"',(0,r.kt)("a",{parentName:"td",href:"mailto:test@email.com"},"test@email.com"),'"')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_default_bucket")),(0,r.kt)("td",{parentName:"tr",align:null},"Default archive bucket to use."),(0,r.kt)("td",{parentName:"tr",align:null},'"PREFIX-orca-primary"')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_reports_bucket_name")),(0,r.kt)("td",{parentName:"tr",align:null},"The Name of the bucket to store s3 inventory reports."),(0,r.kt)("td",{parentName:"tr",align:null},'"PREFIX-orca-reports"')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"rds_security_group_id")),(0,r.kt)("td",{parentName:"tr",align:null},"Cumulus' RDS Security Group's ID."),(0,r.kt)("td",{parentName:"tr",align:null},'"sg-01234567890123456"')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"s3_access_key")),(0,r.kt)("td",{parentName:"tr",align:null},"Access key for communicating with Orca S3 buckets."),(0,r.kt)("td",{parentName:"tr",align:null})),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"s3_secret_key")),(0,r.kt)("td",{parentName:"tr",align:null},"Secret key for communicating with Orca S3 buckets."),(0,r.kt)("td",{parentName:"tr",align:null})))),(0,r.kt)("h3",{id:"optional-variables"},"Optional Variables"),(0,r.kt)("p",null,"The following variables are optional for the ORCA module and can be set by the\nend user to better adjust ORCA for their specific environment."),(0,r.kt)("h4",{id:"cumulus-optional-variables"},"Cumulus Optional Variables"),(0,r.kt)("p",null,"The following variables should be present already in the ",(0,r.kt)("inlineCode",{parentName:"p"},"cumulus-tf/terraform.tfvars"),"\nfile. The variables can be set with proper values for your environment in the\n",(0,r.kt)("inlineCode",{parentName:"p"},"cumulus-tf/terraform.tfvars")," file. It is recommended that the ",(0,r.kt)("inlineCode",{parentName:"p"},"region")," variable\nis set to the proper AWS region for deployments."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Variable"),(0,r.kt)("th",{parentName:"tr",align:null},"Definition"),(0,r.kt)("th",{parentName:"tr",align:null},"Example Value"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"tags")),(0,r.kt)("td",{parentName:"tr",align:null},"Tags to be applied to resources that support tags."),(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},'{ environment = "development", developer = "me" }'))))),(0,r.kt)("h4",{id:"orca-optional-variables"},"ORCA Optional Variables"),(0,r.kt)("p",null,"The following variables should be present in the ",(0,r.kt)("inlineCode",{parentName:"p"},"cumulus-tf/orca_variables.tf"),"\nfile. The variables can be set with proper values for your environment in the\n",(0,r.kt)("inlineCode",{parentName:"p"},"cumulus-tf/terraform.tfvars")," file. The default setting for each of the optional\nvariables is shown in the table below."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Variable"),(0,r.kt)("th",{parentName:"tr",align:null},"Type"),(0,r.kt)("th",{parentName:"tr",align:null},"Definition"),(0,r.kt)("th",{parentName:"tr",align:null},"Default"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"archive_recovery_queue_message_retention_time_seconds")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"The number of seconds archive-recovery-queue SQS retains a message in seconds."),(0,r.kt)("td",{parentName:"tr",align:null},"777600")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"db_admin_username")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Username for RDS database administrator authentication."),(0,r.kt)("td",{parentName:"tr",align:null},'"postgres"')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"default_multipart_chunksize_mb")),(0,r.kt)("td",{parentName:"tr",align:null},"number"),(0,r.kt)("td",{parentName:"tr",align:null},"The default maximum size of chunks to use when copying. Can be overridden by collection config."),(0,r.kt)("td",{parentName:"tr",align:null},"250")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"internal_report_queue_message_retention_time_seconds")),(0,r.kt)("td",{parentName:"tr",align:null},"number"),(0,r.kt)("td",{parentName:"tr",align:null},"Number of seconds the internal-report-queue SQS retains a message."),(0,r.kt)("td",{parentName:"tr",align:null},"432000")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"metadata_queue_message_retention_time_seconds")),(0,r.kt)("td",{parentName:"tr",align:null},"number"),(0,r.kt)("td",{parentName:"tr",align:null},"Number of seconds the metadata-queue fifo SQS retains a message."),(0,r.kt)("td",{parentName:"tr",align:null},"777600")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"db_name")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"The name of the Orca database within the RDS cluster. Any ",(0,r.kt)("inlineCode",{parentName:"td"},"-")," in ",(0,r.kt)("inlineCode",{parentName:"td"},"prefix")," will be replaced with ",(0,r.kt)("inlineCode",{parentName:"td"},"_"),"."),(0,r.kt)("td",{parentName:"tr",align:null},"PREFIX_orca")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"db_user_name")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"The name of the application user for the Orca database. Any ",(0,r.kt)("inlineCode",{parentName:"td"},"-")," in ",(0,r.kt)("inlineCode",{parentName:"td"},"prefix")," will be replaced with ",(0,r.kt)("inlineCode",{parentName:"td"},"_"),"."),(0,r.kt)("td",{parentName:"tr",align:null},"PREFIX_orcauser")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"log_level")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"sets the verbose of PowerTools logger. Must be one of 'INFO', 'DEBUG', 'WARN', 'ERROR'. Defaults to 'INFO'."),(0,r.kt)("td",{parentName:"tr",align:null},'"INFO"')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_default_recovery_type")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"The Tier for the restore request. Valid values are 'Standard', 'Bulk', 'Expedited'"),(0,r.kt)("td",{parentName:"tr",align:null},'"Standard"')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_default_storage_class")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"The ",(0,r.kt)("a",{parentName:"td",href:"/cumulus-orca/docs/operator/storage-classes"},"class of storage")," to use when ingesting files. Can be overridden by collection config."),(0,r.kt)("td",{parentName:"tr",align:null},'"GLACIER"')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_delete_old_reconcile_jobs_frequency_cron")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Frequency cron for running the delete_old_reconcile_jobs lambda."),(0,r.kt)("td",{parentName:"tr",align:null},'"cron(0 0 ? ',(0,r.kt)("em",{parentName:"td"}," SUN "),')"')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_ingest_lambda_memory_size")),(0,r.kt)("td",{parentName:"tr",align:null},"number"),(0,r.kt)("td",{parentName:"tr",align:null},"Amount of memory in MB the ORCA copy_to_archive lambda can use at runtime."),(0,r.kt)("td",{parentName:"tr",align:null},"2240")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_ingest_lambda_timeout")),(0,r.kt)("td",{parentName:"tr",align:null},"number"),(0,r.kt)("td",{parentName:"tr",align:null},"Timeout in number of seconds for ORCA copy_to_archive lambda."),(0,r.kt)("td",{parentName:"tr",align:null},"600")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_internal_reconciliation_expiration_days")),(0,r.kt)("td",{parentName:"tr",align:null},"number"),(0,r.kt)("td",{parentName:"tr",align:null},"Only reports updated before this many days ago will be deleted."),(0,r.kt)("td",{parentName:"tr",align:null},"30")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_reconciliation_lambda_memory_size")),(0,r.kt)("td",{parentName:"tr",align:null},"number"),(0,r.kt)("td",{parentName:"tr",align:null},"Amount of memory in MB the ORCA reconciliation lambda can use at runtime."),(0,r.kt)("td",{parentName:"tr",align:null},"128")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_reconciliation_lambda_timeout")),(0,r.kt)("td",{parentName:"tr",align:null},"number"),(0,r.kt)("td",{parentName:"tr",align:null},"Timeout in number of seconds for ORCA reconciliation lambdas."),(0,r.kt)("td",{parentName:"tr",align:null},"720")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_recovery_buckets")),(0,r.kt)("td",{parentName:"tr",align:null},"List (string)"),(0,r.kt)("td",{parentName:"tr",align:null},"List of bucket names that ORCA has permissions to restore data to. Default is all in the ",(0,r.kt)("inlineCode",{parentName:"td"},"buckets")," map."),(0,r.kt)("td",{parentName:"tr",align:null},"[]")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_recovery_complete_filter_prefix")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"Specifies object key name prefix by the archive Bucket trigger."),(0,r.kt)("td",{parentName:"tr",align:null},'""')),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_recovery_expiration_days")),(0,r.kt)("td",{parentName:"tr",align:null},"number"),(0,r.kt)("td",{parentName:"tr",align:null},"Number of days a recovered file will remain available for copy."),(0,r.kt)("td",{parentName:"tr",align:null},"5")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_recovery_lambda_memory_size")),(0,r.kt)("td",{parentName:"tr",align:null},"number"),(0,r.kt)("td",{parentName:"tr",align:null},"Amount of memory in MB the ORCA recovery lambda can use at runtime."),(0,r.kt)("td",{parentName:"tr",align:null},"128")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_recovery_lambda_timeout")),(0,r.kt)("td",{parentName:"tr",align:null},"number"),(0,r.kt)("td",{parentName:"tr",align:null},"Timeout in number of seconds for ORCA recovery lambdas."),(0,r.kt)("td",{parentName:"tr",align:null},"720")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_recovery_retry_limit")),(0,r.kt)("td",{parentName:"tr",align:null},"number"),(0,r.kt)("td",{parentName:"tr",align:null},"Maximum number of retries of a recovery failure before giving up."),(0,r.kt)("td",{parentName:"tr",align:null},"3")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_recovery_retry_interval")),(0,r.kt)("td",{parentName:"tr",align:null},"number"),(0,r.kt)("td",{parentName:"tr",align:null},"Number of seconds to wait between recovery failure retries."),(0,r.kt)("td",{parentName:"tr",align:null},"1")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_recovery_retry_backoff")),(0,r.kt)("td",{parentName:"tr",align:null},"number"),(0,r.kt)("td",{parentName:"tr",align:null},"The multiplier by which the retry interval increases during each attempt."),(0,r.kt)("td",{parentName:"tr",align:null},"2")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"s3_inventory_queue_message_retention_time_seconds")),(0,r.kt)("td",{parentName:"tr",align:null},"number"),(0,r.kt)("td",{parentName:"tr",align:null},"The number of seconds s3-inventory-queue fifo SQS retains a message in seconds. Maximum value is 14 days."),(0,r.kt)("td",{parentName:"tr",align:null},"432000")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"s3_report_frequency")),(0,r.kt)("td",{parentName:"tr",align:null},"string"),(0,r.kt)("td",{parentName:"tr",align:null},"How often to generate s3 reports for internal reconciliation. ",(0,r.kt)("inlineCode",{parentName:"td"},"Daily")," or ",(0,r.kt)("inlineCode",{parentName:"td"},"Weekly")),(0,r.kt)("td",{parentName:"tr",align:null},"Daily")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"sqs_delay_time_seconds")),(0,r.kt)("td",{parentName:"tr",align:null},"number"),(0,r.kt)("td",{parentName:"tr",align:null},"Number of seconds that the delivery of all messages in the queue will be delayed."),(0,r.kt)("td",{parentName:"tr",align:null},"0")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"sqs_maximum_message_size")),(0,r.kt)("td",{parentName:"tr",align:null},"number"),(0,r.kt)("td",{parentName:"tr",align:null},"The limit of how many bytes a message can contain before Amazon SQS rejects it."),(0,r.kt)("td",{parentName:"tr",align:null},"262144")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"staged_recovery_queue_message_retention_time_seconds")),(0,r.kt)("td",{parentName:"tr",align:null},"number"),(0,r.kt)("td",{parentName:"tr",align:null},"Number of seconds the staged-recovery-queue fifo SQS retains a message."),(0,r.kt)("td",{parentName:"tr",align:null},"432000")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"status_update_queue_message_retention_time_seconds")),(0,r.kt)("td",{parentName:"tr",align:null},"number"),(0,r.kt)("td",{parentName:"tr",align:null},"Number of seconds the status_update_queue fifo SQS retains a message."),(0,r.kt)("td",{parentName:"tr",align:null},"777600")))),(0,r.kt)("h2",{id:"orca-module-outputs"},"ORCA Module Outputs"),(0,r.kt)("p",null,"The orca module provides the outputs seen below in the table. Outputs are\naccessed using terraform dot syntax in the format of ",(0,r.kt)("inlineCode",{parentName:"p"},"module.orca.variable_name"),"."),(0,r.kt)("table",null,(0,r.kt)("thead",{parentName:"table"},(0,r.kt)("tr",{parentName:"thead"},(0,r.kt)("th",{parentName:"tr",align:null},"Output Variable"),(0,r.kt)("th",{parentName:"tr",align:null},"Description"))),(0,r.kt)("tbody",{parentName:"table"},(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_api_deployment_invoke_url")),(0,r.kt)("td",{parentName:"tr",align:null},"The URL to invoke the ORCA Cumulus reconciliation API gateway. Excludes the resource path")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_graphql_load_balancer_dns_name")),(0,r.kt)("td",{parentName:"tr",align:null},"The DNS Name of the Application Load Balancer that handles access to ORCA GraphQL.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_lambda_copy_to_archive_arn")),(0,r.kt)("td",{parentName:"tr",align:null},"AWS ARN of the ORCA copy_to_archive lambda.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_lambda_extract_filepaths_for_granule_arn")),(0,r.kt)("td",{parentName:"tr",align:null},"AWS ARN of the ORCA extract_filepaths_for_granule lambda.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_lambda_orca_catalog_reporting_arn")),(0,r.kt)("td",{parentName:"tr",align:null},"AWS ARN of the ORCA orca_catalog_reporting lambda.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_lambda_request_from_archive_arn")),(0,r.kt)("td",{parentName:"tr",align:null},"AWS ARN of the ORCA request_from_archive lambda.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_lambda_copy_from_archive_arn")),(0,r.kt)("td",{parentName:"tr",align:null},"AWS ARN of the ORCA copy_from_archive lambda.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_lambda_request_status_for_granule_arn")),(0,r.kt)("td",{parentName:"tr",align:null},"AWS ARN of the ORCA request_status_for_granule lambda.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_lambda_request_status_for_job_arn")),(0,r.kt)("td",{parentName:"tr",align:null},"AWS ARN of the ORCA request_status_for_job lambda.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_lambda_post_copy_request_to_queue_arn")),(0,r.kt)("td",{parentName:"tr",align:null},"AWS ARN of the ORCA post_copy_request_to_queue lambda.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_lambda_orca_catalog_reporting_arn")),(0,r.kt)("td",{parentName:"tr",align:null},"AWS ARN of the ORCA orca_catalog_reporting lambda.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_secretsmanager_arn")),(0,r.kt)("td",{parentName:"tr",align:null},"The Amazon Resource Name (ARN) of the AWS secretsmanager")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_sfn_recovery_workflow_arn")),(0,r.kt)("td",{parentName:"tr",align:null},"The ARN of the recovery step function.")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_sqs_archive_recovery_queue_arn")),(0,r.kt)("td",{parentName:"tr",align:null},"The ARN of the archive-recovery-queue SQS")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_sqs_archive_recovery_queue_id")),(0,r.kt)("td",{parentName:"tr",align:null},"The URL of the archive-recovery-queue SQS")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_sqs_metadata_queue_arn")),(0,r.kt)("td",{parentName:"tr",align:null},"The ARN of the metadata-queue SQS")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_sqs_metadata_queue_id")),(0,r.kt)("td",{parentName:"tr",align:null},"The URL ID of the metadata-queue SQS")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_sqs_staged_recovery_queue_arn")),(0,r.kt)("td",{parentName:"tr",align:null},"The ARN of the staged-recovery-queue SQS")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_sqs_staged_recovery_queue_id")),(0,r.kt)("td",{parentName:"tr",align:null},"The URL ID of the staged-recovery-queue SQS")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_sqs_status_update_queue_arn")),(0,r.kt)("td",{parentName:"tr",align:null},"The ARN of the status-update-queue SQS")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_sqs_status_update_queue_id")),(0,r.kt)("td",{parentName:"tr",align:null},"The URL ID of the status-update-queue SQS")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_subnet_group_id")),(0,r.kt)("td",{parentName:"tr",align:null},"The ORCA database subnet group name")),(0,r.kt)("tr",{parentName:"tbody"},(0,r.kt)("td",{parentName:"tr",align:null},(0,r.kt)("inlineCode",{parentName:"td"},"orca_subnet_group_arn")),(0,r.kt)("td",{parentName:"tr",align:null},"The ARN of the ORCA database subnet group")))),(0,r.kt)("h2",{id:"deploy-orca-with-terraform"},"Deploy ORCA with Terraform"),(0,r.kt)("p",null,"In the proper module directory, initialize and apply changes using the commands\nbelow."),(0,r.kt)("ol",null,(0,r.kt)("li",{parentName:"ol"},"Run ",(0,r.kt)("inlineCode",{parentName:"li"},"terraform init"),"."),(0,r.kt)("li",{parentName:"ol"},"Run ",(0,r.kt)("inlineCode",{parentName:"li"},"terraform plan")," #optional, but allows you to preview the deploy."),(0,r.kt)("li",{parentName:"ol"},"Run ",(0,r.kt)("inlineCode",{parentName:"li"},"terraform apply"),".")),(0,r.kt)("p",null,"This commands above will create and deploy ORCA. To delete the created objects,\nrun ",(0,r.kt)("inlineCode",{parentName:"p"},"terraform destroy"),"."),(0,r.kt)("h2",{id:"collection-configuration"},"Collection Configuration"),(0,r.kt)("p",null,"To configure a collection to enable ORCA, add the line\n",(0,r.kt)("inlineCode",{parentName:"p"},'"granuleRecoveryWorkflow": "OrcaRecoveryWorkflow"')," to the collection configuration\nas seen below."),(0,r.kt)("p",null,"Optionally, you can exclude files by adding values to an\n",(0,r.kt)("inlineCode",{parentName:"p"},"excludedFileExtensions")," variable as seen below.\nIn addition, when dealing with large files, the ",(0,r.kt)("inlineCode",{parentName:"p"},"s3MultipartChunksizeMb")," variable can also be set to override the\ndefault setting set during ORCA installation.\nIf the file should be stored in a ",(0,r.kt)("a",{parentName:"p",href:"/cumulus-orca/docs/operator/storage-classes"},"storage class")," other than the default set in ",(0,r.kt)("inlineCode",{parentName:"p"},"orca_default_storage_class")," during installation, specify it using ",(0,r.kt)("inlineCode",{parentName:"p"},"defaultStorageClassOverride"),".\nFor more information, see the documentation on the\n",(0,r.kt)("a",{parentName:"p",href:"https://github.com/nasa/cumulus-orca/tree/master/tasks/copy_to_archive"},(0,r.kt)("inlineCode",{parentName:"a"},"copy_to_archive")," task"),"."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "queriedAt": "2019-11-07T22:49:46.842Z",\n  "name": "L0A_HR_RAW",\n  "version": "1",\n  "sampleFileName": "L0A_HR_RAW_product_0001-of-0420.h5",\n  "dataType": "L0A_HR_RAW",\n  "granuleIdExtraction": "^(.*)((\\\\.cmr\\\\.json)|(\\\\.iso\\\\.xml)|(\\\\.tar\\\\.gz)|(\\\\.h5)|(\\\\.h5\\\\.mp))$",\n  "reportToEms": true,\n  "granuleId": "^.*$",\n  "provider_path": "L0A_HR_RAW/",\n  "meta": {\n    "s3MultipartChunksizeMb": 400,\n    "granuleRecoveryWorkflow": "OrcaRecoveryWorkflow",\n    "orca": {\n      "excludedFileExtensions": [".cmr", ".xml", ".met"],\n      "defaultBucketOverride": "prod_orca_worm",\n      "defaultRecoveryTypeOverride": "Standard",\n      "defaultStorageClassOverride": "DEEP_ARCHIVE"\n    }\n  },\n}\n')),(0,r.kt)("h2",{id:"enable-recover-granule-button"},"Enable ",(0,r.kt)("inlineCode",{parentName:"h2"},"Recover Granule")," Button"),(0,r.kt)("p",null,"To enable the ",(0,r.kt)("inlineCode",{parentName:"p"},"Recover Granule")," button on the Cumulus Dashboard (available at github.com/nasa/cumulus-dashboard),\nset the environment variable ",(0,r.kt)("inlineCode",{parentName:"p"},"ENABLE_RECOVERY=true"),"."),(0,r.kt)("p",null,"Here is an sample command to run the Cumulus Dashboard locally."),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-bash"},"APIROOT=https://uttm5y1jcj.execute-api.us-west-2.amazonaws.com:8000/dev ENABLE_RECOVERY=true npm run serve\n")))}p.isMDXComponent=!0}}]);