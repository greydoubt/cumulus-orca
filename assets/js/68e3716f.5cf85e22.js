"use strict";(self.webpackChunkorca_website=self.webpackChunkorca_website||[]).push([[3573,2083],{6343:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>m,contentTitle:()=>d,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>u});var n=a(7462),l=(a(7294),a(3905)),i=a(4079),r=a(4996);const o={id:"research-reconciliation",title:"ORCA Reconciliation",description:"Initial notes, design and ideas related to ORCA Reconciliation with Cumulus"},d=void 0,s={unversionedId:"developer/research/research-reconciliation",id:"developer/research/research-reconciliation",title:"ORCA Reconciliation",description:"Initial notes, design and ideas related to ORCA Reconciliation with Cumulus",source:"@site/docs/developer/research/research-reconciliation.mdx",sourceDirName:"developer/research",slug:"/developer/research/research-reconciliation",permalink:"/cumulus-orca/docs/developer/research/research-reconciliation",draft:!1,editUrl:"https://github.com/nasa/cumulus-orca/edit/develop/website/docs/developer/research/research-reconciliation.mdx",tags:[],version:"current",frontMatter:{id:"research-reconciliation",title:"ORCA Reconciliation",description:"Initial notes, design and ideas related to ORCA Reconciliation with Cumulus"},sidebar:"dev_guide",previous:{title:"API Gateway Research Notes",permalink:"/cumulus-orca/docs/developer/research/research-APIGateway"},next:{title:"Aurora Serverless Research Notes",permalink:"/cumulus-orca/docs/developer/research/research-AuroraServerless"}},m={},u=[{value:"Metadata Needed for Cumulus Comparison",id:"metadata-needed-for-cumulus-comparison",level:2},{value:"Relationship of the Metadata Objects",id:"relationship-of-the-metadata-objects",level:3},{value:"Potential Attributes of the Metadata Objects",id:"potential-attributes-of-the-metadata-objects",level:3},{value:"Provider Metadata Object",id:"provider-metadata-object",level:4},{value:"Collection Metadata Object",id:"collection-metadata-object",level:4},{value:"Granule Metadata Object",id:"granule-metadata-object",level:4},{value:"File Metadata Object",id:"file-metadata-object",level:4},{value:"File Version Object",id:"file-version-object",level:4},{value:"Return Metadata Needed by Cumulus",id:"return-metadata-needed-by-cumulus",level:3},{value:"Potential ORCA Reconciliation Data Reporting Architecture",id:"potential-orca-reconciliation-data-reporting-architecture",level:3},{value:"Populating the metadata",id:"populating-the-metadata",level:2},{value:"Automated Cumulus Ingest Workflow",id:"automated-cumulus-ingest-workflow",level:3},{value:"Boto3 Copy Test",id:"boto3-copy-test",level:4},{value:"Boto3 Get Additional File Information",id:"boto3-get-additional-file-information",level:4},{value:"Boto3 Use Multipart Copy",id:"boto3-use-multipart-copy",level:4},{value:"Manually Run ORCA Ingest Workflows",id:"manually-run-orca-ingest-workflows",level:3},{value:"Back Population of the ORCA Catalog",id:"back-population-of-the-orca-catalog",level:3},{value:"Potential ORCA Catalog Population Architecture",id:"potential-orca-catalog-population-architecture",level:3},{value:"Possible Technologies for Enabling the Work",id:"possible-technologies-for-enabling-the-work",level:2},{value:"API Gateway",id:"api-gateway",level:3},{value:"GraphQL",id:"graphql",level:3},{value:"SQS",id:"sqs",level:3},{value:"AWS PostgreSQL RDS Offerings",id:"aws-postgresql-rds-offerings",level:3},{value:"NodeJS (Knex) / Python (SQLAlchemy)",id:"nodejs-knex--python-sqlalchemy",level:3},{value:"Comparison between ORCA S3 and the ORCA Catalog",id:"comparison-between-orca-s3-and-the-orca-catalog",level:2},{value:"Getting a Listing from AWS S3",id:"getting-a-listing-from-aws-s3",level:3},{value:"Example Using list_objects_v2",id:"example-using-list_objects_v2",level:4},{value:"Potential Internal Reconciliation Architecture",id:"potential-internal-reconciliation-architecture",level:3},{value:"S3 Inventory Report",id:"s3-inventory-report",level:3},{value:"Potential Internal Reporting Database Structure",id:"potential-internal-reporting-database-structure",level:3},{value:"Status Table reconcile_status",id:"status-table-reconcile_status",level:4},{value:"Internal Reconciliation Jobs Table reconcile_job",id:"internal-reconciliation-jobs-table-reconcile_job",level:4},{value:"S3 Inventory Temporary Table reconcile_s3_object",id:"s3-inventory-temporary-table-reconcile_s3_object",level:4},{value:"Internal Reconciliation Reporting Table Orphaned Files reconcile_orphan_report",id:"internal-reconciliation-reporting-table-orphaned-files-reconcile_orphan_report",level:4},{value:"Internal Reconciliation Reporting Table S3 Missing reconcile_phantom_report",id:"internal-reconciliation-reporting-table-s3-missing-reconcile_phantom_report",level:4},{value:"Internal Reconciliation Reporting Table Catalog Missing or Mismatches reconcile_mismatch_report",id:"internal-reconciliation-reporting-table-catalog-missing-or-mismatches-reconcile_mismatch_report",level:4},{value:"Open Questions yet to be answered",id:"open-questions-yet-to-be-answered",level:2},{value:"Additional Artifacts from the Research",id:"additional-artifacts-from-the-research",level:2},{value:"Aqua Data Studio ERD File",id:"aqua-data-studio-erd-file",level:3},{value:"Schema Install SQL Scripts",id:"schema-install-sql-scripts",level:3},{value:"Notes from ORCA schema refinement research",id:"notes-from-orca-schema-refinement-research",level:2},{value:"Refined Granule Metadata Object",id:"refined-granule-metadata-object",level:4},{value:"Refined ERD File &amp; SQL script",id:"refined-erd-file--sql-script",level:3},{value:"Addressing open questions",id:"addressing-open-questions",level:3}],p={toc:u},c="wrapper";function h(e){let{components:t,...a}=e;return(0,l.kt)(c,(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,l.kt)("p",null,"As part of enhancing ORCA, a needed feature by the working group is being able to\nreconcile between the ORCA inventory and the Cumulus inventory to determine what\nfile(s) are missing or extra in each catalog. The ORCA team has met with Cumulus\nseveral times to understand current reconciliation patterns. Notes from those\ninterface meetings are available below. In addition, there are several resources\navailable from Cumulus and LZARDS which also has to deal with reconciliation in\na manor similar to ORCA. It is understood that ORCA will provide the data, but\nCumulus will perform the comparison and reporting work to match current reconcile\npatterns."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://wiki.earthdata.nasa.gov/pages/viewpage.action?pageId=195434181"},"January 28, 2020 Meeting Notes")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://wiki.earthdata.nasa.gov/pages/viewpage.action?pageId=199918974"},"March 4, 2021 Meeting Notes")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://wiki.earthdata.nasa.gov/pages/viewpage.action?pageId=202806645"},"March 29, 2021 Meeting Notes")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://wiki.earthdata.nasa.gov/display/CUMULUS/Prototype+LZARDS+reconciliation+reports"},"LZARDS Prototype Reconciliation Reports")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://nasa.github.io/cumulus-api/#create-reconciliation-report"},"Cumulus Reconciliation API")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://github.com/nasa/cumulus/tree/1e6d63deab3e0cf464b2e8b545258ba1ebb4e05d/lambdas/db-migration/src/migrations"},"Cumulus table definitions"))),(0,l.kt)("h2",{id:"metadata-needed-for-cumulus-comparison"},"Metadata Needed for Cumulus Comparison"),(0,l.kt)("p",null,"The following filters can be applied to a query for determining which files to\nbring back for catalog comparison between the Cumulus inventory and ORCA."),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Name"),(0,l.kt)("th",{parentName:"tr",align:null},"Data Type"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"providerId"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"List[str]")),(0,l.kt)("td",{parentName:"tr",align:null},"The unique ID of the provider(s) making the request.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"collectionId"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"List[str]")),(0,l.kt)("td",{parentName:"tr",align:null},"The unique ID of collection(s) to compare.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"granuleId"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"List[str]")),(0,l.kt)("td",{parentName:"tr",align:null},"The unique ID of granule(s) to compare.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"startTimestamp"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"timestamp")),(0,l.kt)("td",{parentName:"tr",align:null},"Start time for cumulus_create_time date range to compare data.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"endTimestamp"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"timestamp")),(0,l.kt)("td",{parentName:"tr",align:null},"End time for cumulus_create_time date range to compare data.")))),(0,l.kt)("p",null,"When querying ORCA for the information these filters will be AND together for a\ncomparison answer."),(0,l.kt)("p",null,"The sections below provide information on how these filters relate with the\nexpected metadata objects, the attributes those data objects may need for comparison\nand investigation, and other items related to the data when making the comparison."),(0,l.kt)("p",null,"The metadata objects include the following."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"Provider")," (providerId)"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"Collection")," (collectionId)"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"Granule")," (granuleId, startTimestamp, endTimestamp)"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"File")," - Needed for comparison."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("strong",{parentName:"li"},"File Version")," - Needed for comparison, latest version only.")),(0,l.kt)("h3",{id:"relationship-of-the-metadata-objects"},"Relationship of the Metadata Objects"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"A ",(0,l.kt)("strong",{parentName:"li"},"Provider")," contains an unique ID and is made up of one or more Collections."),(0,l.kt)("li",{parentName:"ul"},"A ",(0,l.kt)("strong",{parentName:"li"},"Collection")," contains an unique ID that contains the short name, and version and is made up of one or more Granules."),(0,l.kt)("li",{parentName:"ul"},"A ",(0,l.kt)("strong",{parentName:"li"},"Granule")," contains an unique ID and is made up of one or more Files."),(0,l.kt)("li",{parentName:"ul"},"A ",(0,l.kt)("strong",{parentName:"li"},"File")," contains a name unique to the ",(0,l.kt)("em",{parentName:"li"},"Granule ID")," and is made up of one or more File Versions."),(0,l.kt)("li",{parentName:"ul"},"A ",(0,l.kt)("strong",{parentName:"li"},"File Version")," contains the versions, sizes, hashes and etags of a file along with pertinent dates.")),(0,l.kt)("h3",{id:"potential-attributes-of-the-metadata-objects"},"Potential Attributes of the Metadata Objects"),(0,l.kt)("p",null,"The following provides the potential metadata attributes that need to be captured\nfor each object in order to properly filter and provide information back to Cumulus\nfor reconciliation and Operator investigation of discrepancies.\nA draft schema for how the objects would interact and be tied together can be\nseen below."),(0,l.kt)(i.default,{imageSource:(0,r.Z)("img/Research-Reconciliation-orca-inventory-schema.png"),imageAlt:"System Context",zoomInPic:(0,r.Z)("img/zoom-in.svg"),zoomOutPic:(0,r.Z)("img/zoom-out.svg"),resetPic:(0,r.Z)("img/zoom-pan-reset.svg"),mdxType:"MyImage"}),(0,l.kt)("admonition",{title:"Optional Attributes",type:"note"},(0,l.kt)("p",{parentName:"admonition"},"When noted, optional attributes are items not strictly needed for reconciliation\nbut may provide value for additional enhancements which may occur in the future\nto query and filter the data for data management activities.")),(0,l.kt)("h4",{id:"provider-metadata-object"},"Provider Metadata Object"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Attribute Name"),(0,l.kt)("th",{parentName:"tr",align:null},"Data Type"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"),(0,l.kt)("th",{parentName:"tr",align:null},"Notable Items"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"provider_id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"providerId that is provided by Cumulus."),(0,l.kt)("td",{parentName:"tr",align:null},"Must be unique.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"name"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Unique name of the provider."),(0,l.kt)("td",{parentName:"tr",align:null},"Optional but may provide more value for future items.")))),(0,l.kt)("h4",{id:"collection-metadata-object"},"Collection Metadata Object"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Attribute Name"),(0,l.kt)("th",{parentName:"tr",align:null},"Data Type"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"),(0,l.kt)("th",{parentName:"tr",align:null},"Notable Items"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"collection_id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"collectionId that is provided by Cumulus."),(0,l.kt)("td",{parentName:"tr",align:null},"Must be unique per providerId.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"shortname"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Short name of the collection (AST_L1A)."),(0,l.kt)("td",{parentName:"tr",align:null},"Optional but may provide more value for future items.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"version"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Version of the collection (061)."),(0,l.kt)("td",{parentName:"tr",align:null},"Optional but may provide more value for future items.")))),(0,l.kt)("p",null,"I also considered adding attributes for collection configuration information like\nthe ",(0,l.kt)("em",{parentName:"p"},"excluded file types"),", ",(0,l.kt)("em",{parentName:"p"},"default archive bucket"),", and other ORCA configurations.\nThinking through it though, I felt it was better to leave these with Cumulus and\nperform a lookup if they are needed. This was primarily for two reasons. First,\nthere are really no need for them for reconciliation within ORCA. Second, keeping\nthe values in sync with changes made by operators through the Cumulus Dashboard\nseemed a bit challenging and did not appear to provide a real benefit."),(0,l.kt)("h4",{id:"granule-metadata-object"},"Granule Metadata Object"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Attribute Name"),(0,l.kt)("th",{parentName:"tr",align:null},"Data Type"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"),(0,l.kt)("th",{parentName:"tr",align:null},"Notable Items"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Internal ORCA granule ID pseudo key."),(0,l.kt)("td",{parentName:"tr",align:null},"None")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"collection_id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Collection ID from Cumulus that references the Collections table."),(0,l.kt)("td",{parentName:"tr",align:null},"None")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"cumulus_create_time"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"timestamp")),(0,l.kt)("td",{parentName:"tr",align:null},"createdAt time from Cumulus"),(0,l.kt)("td",{parentName:"tr",align:null},"None")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"cumulus_granule_id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"granuleId that is provided by Cumulus."),(0,l.kt)("td",{parentName:"tr",align:null},"Must be unique per collectionId")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"execution_id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Step function execution ID from AWS."),(0,l.kt)("td",{parentName:"tr",align:null},"Unique ID automatically generated by AWS")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ingest_time"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"timestamp")),(0,l.kt)("td",{parentName:"tr",align:null},"Date and time in UTC that the data was originally ingested into ORCA."),(0,l.kt)("td",{parentName:"tr",align:null},"None")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"last_update"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"timestamp")),(0,l.kt)("td",{parentName:"tr",align:null},"Date and time in UTC that information was updated."),(0,l.kt)("td",{parentName:"tr",align:null},"None")))),(0,l.kt)("p",null,"Note that the combination of the Cumulus Granule ID (cumulus_granule_id) and\nthe Cumulus Collection ID (collection_id) is unique in the\n",(0,l.kt)("a",{parentName:"p",href:"https://github.com/nasa/cumulus/blob/master/lambdas/db-migration/src/migrations/20201014105058_create_granules_table.ts"},"Cumulus granules table"),"."),(0,l.kt)("h4",{id:"file-metadata-object"},"File Metadata Object"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Attribute Name"),(0,l.kt)("th",{parentName:"tr",align:null},"Data Type"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"),(0,l.kt)("th",{parentName:"tr",align:null},"Notable Items"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Internal ORCA file ID"),(0,l.kt)("td",{parentName:"tr",align:null},"None")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"granule_id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Granule that the file belongs to references the internal ORCA granule ID."),(0,l.kt)("td",{parentName:"tr",align:null},"None")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"name"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Name of the file. (MOD14A1.061.2020245.hdf)"),(0,l.kt)("td",{parentName:"tr",align:null},"Must be unique per granuleId")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"orca_archive_location"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"ORCA S3 Glacier bucket the file resides in."),(0,l.kt)("td",{parentName:"tr",align:null},"None")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"cumulus_archive_location"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Cumulus S3 bucket the file is expected to reside in."),(0,l.kt)("td",{parentName:"tr",align:null},"None")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"key_path"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"S3 path to the file including the file name and extension, but not the bucket."),(0,l.kt)("td",{parentName:"tr",align:null},"Must be unique per archive location")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ingest_time"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"timestamp")),(0,l.kt)("td",{parentName:"tr",align:null},"Date and time in UTC that the data was originally ingested into ORCA"),(0,l.kt)("td",{parentName:"tr",align:null},"None")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"etag"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"etag of the file object in the AWS S3 Glacier bucket."),(0,l.kt)("td",{parentName:"tr",align:null},"None")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"version"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"AWS provided version of the file."),(0,l.kt)("td",{parentName:"tr",align:null},"Must be unique per file name/key_path")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"size_in_bytes"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"int")),(0,l.kt)("td",{parentName:"tr",align:null},"Size in bytes of the file. From Cumulus ingest."),(0,l.kt)("td",{parentName:"tr",align:null},"Part of object passed to archive from Cumulus.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"hash"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Checksum hash of the file provided by Cumulus."),(0,l.kt)("td",{parentName:"tr",align:null},"Optional. Part of object passed to archive from Cumulus.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"hash_type"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Hash type used to calculate the hash value of the file."),(0,l.kt)("td",{parentName:"tr",align:null},"Optional. Part of object passed to archive from Cumulus.")))),(0,l.kt)("p",null,"Note that in Cumulus the combination of the bucket (cumulus_archive_location)\nand key (key_path) is unique in the ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/nasa/cumulus/blob/master/lambdas/db-migration/src/migrations/20201014105102_create_files_table.ts"},"Cumulus files table"),"."),(0,l.kt)("h4",{id:"file-version-object"},"File Version Object"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Attribute Name"),(0,l.kt)("th",{parentName:"tr",align:null},"Data Type"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"),(0,l.kt)("th",{parentName:"tr",align:null},"Notable Items"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"version"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"AWS provided version of the file."),(0,l.kt)("td",{parentName:"tr",align:null},"Must be unique per file name/key_path")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"is_latest"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"boolean")),(0,l.kt)("td",{parentName:"tr",align:null},"AWS provided flag denoting that it is the latest version."),(0,l.kt)("td",{parentName:"tr",align:null},"Only one can be latest per file name/key_path. Depending of final table structure this may be optional.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"etag"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"AWS provided etag of the versioned file. Semi unique"),(0,l.kt)("td",{parentName:"tr",align:null},"Potentially optional maybe able to be used for internal comparisons and/or data management investigations.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"cumulus_etag"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Cumulus provided AWS etag of the file in Cumulus."),(0,l.kt)("td",{parentName:"tr",align:null},"Potentially optional. Would need to determine if this information passed along. May be helpful for data management comparisons.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"size_in_bytes"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"bigint")),(0,l.kt)("td",{parentName:"tr",align:null},"Size in bytes of the file. From Cumulus ingest."),(0,l.kt)("td",{parentName:"tr",align:null},"Part of object passed to archive from Cumulus.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"hash"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Checksum hash of the file provided by Cumulus."),(0,l.kt)("td",{parentName:"tr",align:null},"Part of object passed to archive from Cumulus.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"hash_type"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Hash type used to calculate the hash value of the file."),(0,l.kt)("td",{parentName:"tr",align:null},"Part of object passed to archive from Cumulus.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ingest_time"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"timestamp")),(0,l.kt)("td",{parentName:"tr",align:null},"Date and time in UTC that the file was ingested into ORCA"),(0,l.kt)("td",{parentName:"tr",align:null},"None")))),(0,l.kt)("p",null,"It is possible that we may want to merge the ",(0,l.kt)("strong",{parentName:"p"},"File Version Object")," with the\n",(0,l.kt)("strong",{parentName:"p"},"File Object"),". If we were to merge the two objects, here are some things to\nconsider. By merging the objects we would likely only keep the latest version\ninformation of the file in the table. By doing this we do simplify reconciliation\nwith Cumulus but, then the only catalog of all the versions available for a file\nwould reside in the glacier S3 bucket. The implication of this is there is no other\nrecord of the various versions of the file. Also, we should need to query the S3\nbucket if the data manager wanted to inquire what versions were available for a\nfile in order to restore the proper version back or to identify versions that may\nbe eligible for deletions based on policy. If we merge the objects, we may want to\ncapture the total versions available for the file."),(0,l.kt)("h3",{id:"return-metadata-needed-by-cumulus"},"Return Metadata Needed by Cumulus"),(0,l.kt)("p",null,"At a minimum, the following metadata should be returned back to Cumulus upon a\nsuccessful query for reconciliation return from ORCA. The data below is what\nis needed for reconciliation comparison and general metadata that may be needed\nby the end user to perform analysis on discrepancies."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Provider ID (providerId)"),(0,l.kt)("li",{parentName:"ul"},"Collection ID (collectionId)"),(0,l.kt)("li",{parentName:"ul"},"Shortname"),(0,l.kt)("li",{parentName:"ul"},"collection Version"),(0,l.kt)("li",{parentName:"ul"},"Granule ID (granuleId)"),(0,l.kt)("li",{parentName:"ul"},"Cumulus create time"),(0,l.kt)("li",{parentName:"ul"},"Execution ID"),(0,l.kt)("li",{parentName:"ul"},"Granule Ingest Date (ORCA) - may also be referred to as a Create Date."),(0,l.kt)("li",{parentName:"ul"},"Granule Last Update (ORCA)"),(0,l.kt)("li",{parentName:"ul"},"File Name"),(0,l.kt)("li",{parentName:"ul"},"ORCA Location - archive bucket + archive path"),(0,l.kt)("li",{parentName:"ul"},"Cumulus Archive Location"),(0,l.kt)("li",{parentName:"ul"},"Key Path"),(0,l.kt)("li",{parentName:"ul"},"Etag"),(0,l.kt)("li",{parentName:"ul"},"File Size"),(0,l.kt)("li",{parentName:"ul"},"File Hash (Optional)"),(0,l.kt)("li",{parentName:"ul"},"File Hash Type (Optional)"),(0,l.kt)("li",{parentName:"ul"},"File Version (always send back latest version to compare)")),(0,l.kt)("p",null,"A rough structure may look like the following below. In order to simplify\ncomparisons, only the latest file version information will be returned. Enhancements\nwe will need consider later include items like updating the latest flag in the\ndatabase and glacier on a file version when doing a recovery."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-json"},'{\n  "anotherPage": false,\n  "granules": [\n    {\n      "providerId": "lpdaac",\n      "collectionId": "MOD14A1___061",\n      "id": "MOD14A1.061.A23V45.2020235",\n      "createdAt": "2020-01-01T23:00:00Z",\n      "executionId": "u654-123-Yx679",\n      "ingestDate": "2020-01-01T23:00:00Z",\n      "lastUpdate": "2020-01-01T23:00:00Z",\n      "files": [\n        {\n          "name": "MOD14A1.061.A23V45.2020235.2020240145621.hdf",\n          "cumulusArchiveLocation": "cumulus-bucket",\n          "orcaArchiveLocation": "orca-archive",\n          "keyPath": "MOD14A1/061/032/MOD14A1.061.A23V45.2020235.2020240145621.hdf",\n          "sizeBytes": 100934568723,\n          "hash": "ACFH325128030192834127347",\n          "hashType": "SHA-256",\n          "version": "VXCDEG902"\n        },\n        ...\n      ]\n    },\n    ...\n  ]\n}\n')),(0,l.kt)("p",null,"Some items we will need to think about include managing paging (start/stop) for\nlarge returns and limiting size of the message across the wire.\nAdditionally, results should be ordered by granule_id."),(0,l.kt)("h3",{id:"potential-orca-reconciliation-data-reporting-architecture"},"Potential ORCA Reconciliation Data Reporting Architecture"),(0,l.kt)("p",null,"The following provides a rough, high level architecture for reporting the ORCA\nholdings to Cumulus. When providing data back to Cumulus, the solution should be\nable to handle the filters supplied and return back the needed data. In addition,\nthe solution should be extensible and should allow for potential changes in the\nunderlying data structure or storage engine as ORCA should be able to handle AWS\nPostgreSQL RDS, AWS Aurora PostgreSQL, and AWS Aurora PostgreSQL Serverless\nofferings."),(0,l.kt)(i.default,{imageSource:(0,r.Z)("img/Research-Reconciliation-Cumulus-Reconcile.png"),imageAlt:"System Context",zoomInPic:(0,r.Z)("img/zoom-in.svg"),zoomOutPic:(0,r.Z)("img/zoom-out.svg"),resetPic:(0,r.Z)("img/zoom-pan-reset.svg"),mdxType:"MyImage"}),(0,l.kt)("h2",{id:"populating-the-metadata"},"Populating the metadata"),(0,l.kt)("p",null,"Populating the metadata objects with the proper metadata will need to come from\nvarious sources. The sections below will go through thoughts and ideas of where\nthe metadata will originate from to populate the objects and potential ideas on\nwhat the underlying architecture may look like to perform the tasks."),(0,l.kt)("h3",{id:"automated-cumulus-ingest-workflow"},"Automated Cumulus Ingest Workflow"),(0,l.kt)("p",null,"The conventional way of populating the objects with metadata would be through\nthe normal Cumulus ingest workflow that contains ORCA's ",(0,l.kt)("inlineCode",{parentName:"p"},"copy_to_archive")," lambda.\nThe ",(0,l.kt)("inlineCode",{parentName:"p"},"copy_to_archive")," lambda would need to be modified to take or pull additional\nmetadata needed to associate a granule's files to Cumulus, like ",(0,l.kt)("inlineCode",{parentName:"p"},"providerId"),",\n",(0,l.kt)("inlineCode",{parentName:"p"},"collectionId"),", ",(0,l.kt)("inlineCode",{parentName:"p"},"granuleId"),", and various other file metadata information. The\nadditional collected metadata would sent to a queue to be written to the ORCA\ncatalog. The body sent to the queue would have enough information for another\nORCA lambda to write and/or update the records for the various objects in the ORCA\ncatalog."),(0,l.kt)("p",null,"Note that this new database write lambda or the ",(0,l.kt)("inlineCode",{parentName:"p"},"copy_to_archive")," lambda may need\nto make some additional queries to the S3 ORCA bucket to pull information like\nversion and other values. Looking at the original ",(0,l.kt)("inlineCode",{parentName:"p"},"copy_to_archive"),", ",(0,l.kt)("inlineCode",{parentName:"p"},"s3.copy"),"\nis used to copy data to the ORCA archive. Based on initial research located\n",(0,l.kt)("a",{parentName:"p",href:"https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html#S3.Client.copy"},"here"),",\nthe ",(0,l.kt)("inlineCode",{parentName:"p"},"s3.copy")," command does not return any information. See the test performed\nbelow. Because of this, we will likely need to perform a listing on the object to\nget additional information like the S3 object version as seen in the sample below.\nSome items to consider when looking at the options for retrieving the additional\nmetadata include:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("em",{parentName:"li"},"speed")," - How fast can I get the needed metadata?"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("em",{parentName:"li"},"cost")," - What is the cost impact of additional gets on the s3 bucket?"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("em",{parentName:"li"},"complexity")," - Where is the best place to put these additional gets? Is the overall design and/or implementation to complex?")),(0,l.kt)("h4",{id:"boto3-copy-test"},"Boto3 Copy Test"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},'import boto3\n\n# Create the Client\ns3_client = boto3.resource(\'s3\')\n\n# Get a source and destination to copy\ncopy_source = {"Bucket": "orca-sandbox-s3-provider", "Key": "MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065111.hdf"}\ncopy_destination = "orca-sandbox-archive"\n\n# perform the copy command\ncopy_command = s3_client.meta.client.copy(copy_source, copy_destination, copy_source["Key"])\n\n# Return results\nprint(copy_command)\nNone\n')),(0,l.kt)("h4",{id:"boto3-get-additional-file-information"},"Boto3 Get Additional File Information"),(0,l.kt)("p",null,"This would occur after an ",(0,l.kt)("inlineCode",{parentName:"p"},"s3.copy")," and assumes that the copy is synchronous and\nthat the file is not be ingested in parallel in a separate ingest pipeline that\nwould lead to a collision."),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},"import boto3\n\n# Create the Client\ns3_client = boto3.resource('s3')\n\n# Get a source and destination to copy\ncopy_source = {\"Bucket\": \"orca-sandbox-s3-provider\", \"Key\": \"MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065111.hdf\"}\ncopy_destination = \"orca-sandbox-archive\"\n\n# Get the versioning information\nfile_versions = s3_client.meta.client.list_object_versions(Bucket=copy_destination, Prefix=copy_source[\"Key\"] )\n\nfor version in file_versions[\"Versions\"]:\n    if version[\"IsLatest\"]:\n        print(version)\n\n\n# Return results\n{\n    'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"',\n    'Size': 6,\n    'StorageClass': 'STANDARD',\n    'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065111.hdf',\n    'VersionId': 'null',\n    'IsLatest': True,\n    'LastModified': datetime.datetime(2021, 5, 18, 16, 25, 58, tzinfo=tzutc()),\n    'Owner': {\n        'DisplayName': 'gsfc-esdis-edc-lpdaac-sandbox-7343-root',\n        'ID': '4d102362d8dc848404655e5418ff76cd342418b8d2ea3a04aa5db133bd6ac1db'\n    }\n}\n")),(0,l.kt)("p",null,"Note that the data we would likely want are ETag, VersionId, Size, and LastModified.\nIn the example above, the file I used was not part of a versioned S3 bucket thus\nthe ",(0,l.kt)("inlineCode",{parentName:"p"},"null")," value for VersionId."),(0,l.kt)("h4",{id:"boto3-use-multipart-copy"},"Boto3 Use Multipart Copy"),(0,l.kt)("p",null,"In addition to the items above, I also looked at multipart copy which would\nreturn the information natively, but there is a 5Mb minimum size limit when\nusing this functionality which is not small enough for some of the small files\nwe may encounter. Reference information on multipart copy is provided below."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html#S3.Client.upload_part_copy"},"Boto3 Upload Part Copy Command")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://docs.aws.amazon.com/AmazonS3/latest/API/API_UploadPartCopy.html"},"AWS API Upload Part Copy Reference"))),(0,l.kt)("h3",{id:"manually-run-orca-ingest-workflows"},"Manually Run ORCA Ingest Workflows"),(0,l.kt)("p",null,"When manually running a workflow to ingest data into ORCA, it is assumed that the\nsame modified ",(0,l.kt)("inlineCode",{parentName:"p"},"copy_to_archive")," lambda used in an automated workflow would be used\nin the manual workflow. This would mean the translation lambda used to pass the\nproper information from the Cumulus Dashboard call to the ",(0,l.kt)("inlineCode",{parentName:"p"},"copy_to_archive")," lambda\nwould need to retrieve and provide information similar to the information that\nis provided by the ",(0,l.kt)("inlineCode",{parentName:"p"},"moveGranules")," lambda in the normal workflow. The translation\nlambda will likely need to leverage Cumulus API calls to get information related\nto the files and granule from Cumulus. The following cards that are planned to be\nworked during PI 21.2 contain information related to this type of workflow and\ntranslation lambda. See the list below."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://bugs.earthdata.nasa.gov/browse/ORCA-173"},"Understanding the Cumulus Dashboard Workflow Call Output")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://bugs.earthdata.nasa.gov/browse/ORCA-175"},"Creating a Translate Lambda for Cumulus Dashboard Inputs for copy_to_archive")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://bugs.earthdata.nasa.gov/browse/ORCA-182"},"Creating a Workflow for Ingesting Missing Files Into ORCA"))),(0,l.kt)("p",null,"Work related to reconciliation will likely require modifications to the translation\nlambda to pull additional information needed. The following are resources that may\nbe utilized to gather additional granule and file information from Cumulus if needed.\nSee the resource links below."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://nasa.github.io/cumulus-api/#retrieve-granule"},"Cumulus API Get Granule Information")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://nasa.github.io/cumulus-api/#bulk-operations"},"Cumulus API Bulk Operations")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://cmr.earthdata.nasa.gov/search/site/docs/search/api.html#c-concept-id"},"CMR API Get Granule Information"))),(0,l.kt)("p",null,"Note that the CMR call may not be necessary depending on the required metadata\nneeded. In addition, the CMR concept ID call can be retrieved from the ",(0,l.kt)("inlineCode",{parentName:"p"},"cmrLink"),"\nkey in the Cumulus API Get Granule Information. There may be some permission\nissues to work through if the collection is not public or the granule is\nhidden for some reason which means we would need to perform a login with a user\nthat would have access to see all of the providers holdings. Additional research\nmay need to be performed to better understand how to gather this information."),(0,l.kt)("h3",{id:"back-population-of-the-orca-catalog"},"Back Population of the ORCA Catalog"),(0,l.kt)("p",null,"Generally, the first two options listed will handle most use cases for adding\ninformation to the ORCA archive. However, for users that already have ORCA\ninstallations that are older than or equal to v3.x, a new workflow will need to\nbe created to back populate the ORCA metadata catalog. Ideally, this workflow\nwould be kicked off as part of the ORCA installation and/or migration."),(0,l.kt)("p",null,"As a general breakdown of the flow, the Lambda or Workflow will need to do the\nfollowing:"),(0,l.kt)("ol",null,(0,l.kt)("li",{parentName:"ol"},"Query Cumulus looking for Collections configured for ORCA."),(0,l.kt)("li",{parentName:"ol"},"Using the list of Collections configured for ORCA, retrieve the granule and file information."),(0,l.kt)("li",{parentName:"ol"},"Get a list of the files in each ORCA bucket."),(0,l.kt)("li",{parentName:"ol"},"Match attributes from the ORCA file list like file name, key path, and size to file(s) in the Cumulus list."),(0,l.kt)("li",{parentName:"ol"},"Create a message body from the information similar to what ",(0,l.kt)("inlineCode",{parentName:"li"},"copy_to_granule")," will perform."),(0,l.kt)("li",{parentName:"ol"},"Send the message body to the SQS FIFO queue so the database lambda can write the record to the database.")),(0,l.kt)("p",null,"There are likely several ways to optimize this flow. The above is just a general\nconcept to help get the information needed to match files. Collection regex information\ncould also possibly be used. The Cumulus ",(0,l.kt)("a",{parentName:"p",href:"https://github.com/nasa/cumulus/blob/master/lambdas/db-migration/src/migrations/20201014105102_create_files_table.ts"},"files table"),"\nallows us to match key based on our listing, but the combination of key and Cumulus\nbucket are unique unique which means we could match multiple records based on\nkey alone."),(0,l.kt)("p",null,'Note that this concept of back populating by matching data is not 100% accurate\nand is a best attempt to pull data and match it without "re-ingesting" items\nback into ORCA. This approach will likely need lots of logging and reporting to\nlet end users know where discrepancies and best guesses or misses occur. We\nshould also talk with end users about this option prior to implementing to\ndetermine if this is needed.'),(0,l.kt)("p",null,"After discussions with the ",(0,l.kt)("a",{parentName:"p",href:"https://wiki.earthdata.nasa.gov/display/CUMULUS/ORCA+Working+Group"},"ORCA Working Group"),"\nduring the ",(0,l.kt)("a",{parentName:"p",href:"https://wiki.earthdata.nasa.gov/display/CUMULUS/2021-06-02+ORCA+Meeting+Notes"},"June meeting"),"\nthe concept above was discussed. The general consensus from the group was that re-population\nof ORCA through a standalone workflow similar to the items laid out in the\n",(0,l.kt)("a",{parentName:"p",href:"#manually-run-orca-ingest-workflows"},"manual run")," was the best option. In addition,\nthe question of whether the back population method described above was a\nworthwhile path to pursue was posed on the orca Slack channel and the users\ncurrently using ORCA all agreed they would rather re-ingest into ORCA as seen by\nthe Slack thread ",(0,l.kt)("a",{parentName:"p",href:"https://eosdis.slack.com/archives/CSXEM5MPX/p1622735484015400"},"here"),"."),(0,l.kt)("h3",{id:"potential-orca-catalog-population-architecture"},"Potential ORCA Catalog Population Architecture"),(0,l.kt)("p",null,"The following is a potential architecture for populating the ORCA catalog under\nnormal use cases. Note that the SQS queue and ",(0,l.kt)("inlineCode",{parentName:"p"},"orca_catalog_ingest")," lambda could\nbe replaced with a GraphQL server if deemed appropriate."),(0,l.kt)(i.default,{imageSource:(0,r.Z)("img/Research-Reconciliation-Catalog-Population.png"),imageAlt:"System Context",zoomInPic:(0,r.Z)("img/zoom-in.svg"),zoomOutPic:(0,r.Z)("img/zoom-out.svg"),resetPic:(0,r.Z)("img/zoom-pan-reset.svg"),mdxType:"MyImage"}),(0,l.kt)("h2",{id:"possible-technologies-for-enabling-the-work"},"Possible Technologies for Enabling the Work"),(0,l.kt)("p",null,"The following is a short list of technologies that could be leveraged during this\nwork. These technologies fall within current architectures for Cumulus and\nextensions and may contribute to more rapid development of features as we progress.\nA full list of AWS services available in NGAP is available ",(0,l.kt)("a",{parentName:"p",href:"https://wiki.earthdata.nasa.gov/display/ESKB/AWS+Services+Approval+Status+Page"},"here"),"."),(0,l.kt)("h3",{id:"api-gateway"},"API Gateway"),(0,l.kt)("p",null,"The ORCA API Gateway provides an entry point for the Cumulus dashboard and users\nto interact directly with ORCA. For more information on the ORCA API gateway, see\nthe ",(0,l.kt)("a",{parentName:"p",href:"/cumulus-orca/docs/developer/research/research-APIGateway"},"API Gateway research page"),". All reconciliation\ncalls from Cumulus should occur through the ORCA API Gateway."),(0,l.kt)("h3",{id:"graphql"},"GraphQL"),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"https://graphql.org/learn/"},"GraphQL")," is a query language for APIs. This is an\nadditional research spike topic. The promise of this route further consolidates\nour database read/write code while at the same time providing a single API endpoint\nfor clients (both ORCA and Cumulus) to retrieve the data from ORCA. This technology\nthough adding some complexity could simplify some code and design aspects."),(0,l.kt)("p",null,"Research aspects would include GraphQL server to use (COTS or home built). Impacts\nto AWS account (cost, speed, capabilities, security). Synergy with other projects\nlike Cumulus."),(0,l.kt)("p",null,"Some initial resources to start would include the following:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://www.moesif.com/blog/graphql/technical/Ways-To-Add-GraphQL-To-Your-Postgres-Database-Comparing-Hasura-Prisma-and-Others/"},"GraphQL Servers (prebuilt)")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://www.howtographql.com/choose/"},"Build your Own GraphQL Server")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://www.edx.org/course/exploring-graphql-a-query-language-for-apis"},"GraphQL classes")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://git.earthdata.nasa.gov/projects/CMRQL/repos/hackfest-cmr-graphql/browse"},"GraphQL Example with CMR")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("a",{parentName:"li",href:"https://www.apollographql.com/docs/apollo-server/deployment/lambda/"},"Using Apollo Server as a Lambda"))),(0,l.kt)("h3",{id:"sqs"},"SQS"),(0,l.kt)("p",null,(0,l.kt)("a",{parentName:"p",href:"https://docs.aws.amazon.com/AWSSimpleQueueService/latest/SQSDeveloperGuide/FIFO-queues.html"},"AWS SQS FIFO queues"),"\nshould be used to manage the records to be written to the ORCA database. This\nallows the team to decouple the database code from several lambdas and centralize\nthe code to one area. This may or may not be needed if GraphQL is utilized."),(0,l.kt)("h3",{id:"aws-postgresql-rds-offerings"},"AWS PostgreSQL RDS Offerings"),(0,l.kt)("p",null,"To better align with Cumulus, ORCA will utilize the AWS PostgreSQL RDS offerings.\nSee notes on the ORCA transition to the ORCA database ",(0,l.kt)("a",{parentName:"p",href:"https://wiki.earthdata.nasa.gov/display/ORCA/ORCA+Migration+to+Cumulus+RDS"},"here"),".\nThe resultant code from the reconciliation work should be able to handle working\nwith a PostgreSQL back end. Both PostgreSQL RDS and Amazon Aurora are viable back\nend choices that may be utilized. See a comparison article on the databases\n",(0,l.kt)("a",{parentName:"p",href:"https://aws.amazon.com/blogs/database/is-amazon-rds-for-postgresql-or-amazon-aurora-postgresql-a-better-choice-for-me/"},"here"),"."),(0,l.kt)("h3",{id:"nodejs-knex--python-sqlalchemy"},"NodeJS (Knex) / Python (SQLAlchemy)"),(0,l.kt)("p",null,"An agnostic language framework for working with the database should be used some\noptions include but are not limited to the items described below. Utilizing a\nmore general API may help manage changes to the back end database engine with\nlittle or no code changes."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},(0,l.kt)("a",{parentName:"p",href:"http://knexjs.org/"},"Nodejs and Knex")," is what the Cumulus team currently\nutilizes for database interactions. Implementation could follow best practices\nalready established by the Cumulus team.")),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("p",{parentName:"li"},(0,l.kt)("a",{parentName:"p",href:"https://docs.sqlalchemy.org/en/14/core/"},"Python and SQLAlchemy Core")," is currently\nbeing used in some ORCA code."))),(0,l.kt)("h2",{id:"comparison-between-orca-s3-and-the-orca-catalog"},"Comparison between ORCA S3 and the ORCA Catalog"),(0,l.kt)("p",null,"In addition to the comparison between the Cumulus catalog and ORCA, ORCA will\nalso need to manage and maintain the catalog holdings between the ORCA database\nand the actual contents of the ORCA S3 buckets. This will require comparing the\n",(0,l.kt)("em",{parentName:"p"},"Key"),", ",(0,l.kt)("em",{parentName:"p"},"LastModified"),", ",(0,l.kt)("em",{parentName:"p"},"ETag"),", and ",(0,l.kt)("em",{parentName:"p"},"Size")," keys to the of the files in the bucket\nto the ORCA holdings catalog. Discrepancies should be reported back to the user\nand detail orphan and missing files. We could possibly create a temporary reporting\ntable to hold these values that the Cumulus Dashboard could display for us."),(0,l.kt)("p",null,"Some things to think through when designing this solution are factors of scale\nand managing them. To provide some thought and guidance, LP DAAC (one of the larger\nDAACs) has approximately 300 million files in the archive and growing. If all the\nfiles are also stored in ORCA, we will need to reconcile all the files in a smart\nand somewhat quick way on a semi regular basis."),(0,l.kt)("p",null,"Ideally, this reconciliation would occur on a regular schedule using a rule and\nreports would be stored in the database for users to retrieve the information.\nAdditionally, the code should handle failures gracefully and be able to pick up\nwhere it left off either gathering the current contents in S3 or performing the\nORCA catalog internal comparisons with S3."),(0,l.kt)("p",null,"Future enhancements may include displaying the information on the Cumulus dashboard,\nnotifying operators via email or other means of discrepancies, or automated healing\nof the archive based on reconciliation results."),(0,l.kt)("h3",{id:"getting-a-listing-from-aws-s3"},"Getting a Listing from AWS S3"),(0,l.kt)("p",null,"To get a file listing of an S3 bucket, the ",(0,l.kt)("a",{parentName:"p",href:"https://boto3.amazonaws.com/v1/documentation/api/latest/reference/services/s3.html#S3.Client.list_objects_v2"},"list_objects_v2 method"),"\ncan be used from the boto3 library. An example of the usage can be seen below.\nSome notable items if this library is used includes the following."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Only a max of 1000 objects are returned per call. Additional logic will be needed to page through and get all of the results."),(0,l.kt)("li",{parentName:"ul"},"The listing can be filtered by prefix. Possibly some room here to add configuration to look at the collection lever if a collection can be denoted by prefix."),(0,l.kt)("li",{parentName:"ul"},"Version information is not included, only the latest file information is provided."),(0,l.kt)("li",{parentName:"ul"},"An additional call will need to be made per object to look at versions available for a file."),(0,l.kt)("li",{parentName:"ul"},"Only limited fields are returned from the call."),(0,l.kt)("li",{parentName:"ul"},"Each list call does cost in AWS (tiny fractions of a cent).")),(0,l.kt)("p",null,"Other considerations. It may be easier to load the data from the listing calls\ninto a temporary table in the database and perform a handful of queries to find\nthe delta information instead of looping through and doing a comparison in memory."),(0,l.kt)("h4",{id:"example-using-list_objects_v2"},"Example Using list_objects_v2"),(0,l.kt)("pre",null,(0,l.kt)("code",{parentName:"pre",className:"language-python"},"import boto3\n\n# Set the variables\ns3_client = boto3.resource('s3')\ncopy_destination = \"orca-sandbox-archive\"\n\n# Get the listing\nfiles = s3_client.meta.client.list_objects_v2(Bucket=copy_destination)\n\n# Print the contents\nfor file in files[\"Contents\"]:\n    print(file)\n\n# Results\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065104.cmr.xml', 'LastModified': datetime.datetime(2020, 12, 15, 20, 4, 8, tzinfo=tzutc()), 'ETag': '\"aaf96912124e107bf22016c7695fdcef\"', 'Size': 2320, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065104.hdf', 'LastModified': datetime.datetime(2021, 3, 23, 16, 59, 58, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065104.hdf.met', 'LastModified': datetime.datetime(2020, 12, 15, 20, 4, 7, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065104_ndvi.jpg', 'LastModified': datetime.datetime(2021, 3, 23, 16, 59, 59, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065105.cmr.xml', 'LastModified': datetime.datetime(2020, 12, 17, 16, 35, 22, tzinfo=tzutc()), 'ETag': '\"b4b1ea93026eece5390278d97bfd5c3e\"', 'Size': 2320, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065105.hdf', 'LastModified': datetime.datetime(2021, 3, 23, 16, 59, 58, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065105.hdf.met', 'LastModified': datetime.datetime(2020, 12, 17, 16, 35, 22, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065105_ndvi.jpg', 'LastModified': datetime.datetime(2021, 3, 23, 16, 59, 58, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065106.cmr.xml', 'LastModified': datetime.datetime(2020, 12, 17, 17, 5, 43, tzinfo=tzutc()), 'ETag': '\"67f535ab5d6398c2181ab7cf4763f84b\"', 'Size': 2320, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065106.hdf', 'LastModified': datetime.datetime(2021, 3, 23, 16, 59, 58, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065106.hdf.met', 'LastModified': datetime.datetime(2020, 12, 17, 17, 5, 42, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065106_ndvi.jpg', 'LastModified': datetime.datetime(2021, 3, 23, 16, 59, 58, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065107.cmr.xml', 'LastModified': datetime.datetime(2020, 12, 17, 20, 58, 55, tzinfo=tzutc()), 'ETag': '\"a71512f2cc5aa43edbf3573c76ccf5aa\"', 'Size': 2320, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065107.hdf', 'LastModified': datetime.datetime(2021, 3, 23, 16, 59, 58, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065107.hdf.met', 'LastModified': datetime.datetime(2020, 12, 17, 20, 58, 54, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065107_ndvi.jpg', 'LastModified': datetime.datetime(2021, 3, 23, 16, 59, 59, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065108.cmr.xml', 'LastModified': datetime.datetime(2020, 12, 18, 19, 10, 16, tzinfo=tzutc()), 'ETag': '\"6d76238799f45466a9431a9187aa5c70\"', 'Size': 2320, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065108.hdf', 'LastModified': datetime.datetime(2021, 3, 23, 16, 59, 58, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065108.hdf.met', 'LastModified': datetime.datetime(2020, 12, 18, 19, 10, 14, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065108_ndvi.jpg', 'LastModified': datetime.datetime(2021, 3, 23, 16, 59, 59, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065109.cmr.xml', 'LastModified': datetime.datetime(2020, 12, 18, 19, 19, 21, tzinfo=tzutc()), 'ETag': '\"f7ffec3ced795379e2346183221bd5e8\"', 'Size': 2320, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065109.hdf', 'LastModified': datetime.datetime(2021, 3, 23, 16, 59, 57, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065109.hdf.met', 'LastModified': datetime.datetime(2020, 12, 18, 19, 19, 20, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065109_ndvi.jpg', 'LastModified': datetime.datetime(2021, 3, 23, 16, 59, 57, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065110.cmr.xml', 'LastModified': datetime.datetime(2020, 12, 18, 19, 28, 44, tzinfo=tzutc()), 'ETag': '\"9fe1b5cf984cd64b8b7c31b49560ca6e\"', 'Size': 2320, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065110.hdf', 'LastModified': datetime.datetime(2021, 3, 23, 16, 59, 57, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065110.hdf.met', 'LastModified': datetime.datetime(2020, 12, 18, 19, 28, 44, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065110_ndvi.jpg', 'LastModified': datetime.datetime(2021, 3, 23, 16, 59, 57, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'GLACIER'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065111.hdf', 'LastModified': datetime.datetime(2021, 5, 18, 16, 25, 58, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'STANDARD'}\n{'Key': 'MOD09GQ/006/MOD09GQ.A2017025.h21v00.006.2017034065111_ndvi.jpg', 'LastModified': datetime.datetime(2021, 3, 23, 16, 59, 58, tzinfo=tzutc()), 'ETag': '\"81f4b6c158d25f1fe916ea52e99d1700\"', 'Size': 6, 'StorageClass': 'GLACIER'}\n")),(0,l.kt)("h3",{id:"potential-internal-reconciliation-architecture"},"Potential Internal Reconciliation Architecture"),(0,l.kt)("p",null,"The following provides an architecture of how ORCA internal reconciliation\nmay work in an AWS environment with Cumulus. The architecture uses AWS' S3 Inventory report\ncombined with S3 triggering to fire the\ncomparison off on a normal schedule. Likely the running of this type of job will\nneed to scale.\nWhen returning results through the API, it is recommended that we use a \"path\" parameter that filters based on the file's 'Key'.\nThis will allow Cumulus to build values such as collection into a filter so long\nas they construct keys using it."),(0,l.kt)(i.default,{imageSource:(0,r.Z)("img/Research-Reconciliation-Internal-Reconcile.png"),imageAlt:"System Context",zoomInPic:(0,r.Z)("img/zoom-in.svg"),zoomOutPic:(0,r.Z)("img/zoom-out.svg"),resetPic:(0,r.Z)("img/zoom-pan-reset.svg"),mdxType:"MyImage"}),(0,l.kt)("h3",{id:"s3-inventory-report"},"S3 Inventory Report"),(0,l.kt)("p",null,"S3 Inventory reports are created on S3 buckets and post information about that bucket's contents to another bucket.\nFor our purposes, the following options must be checked:"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"Size"),(0,l.kt)("li",{parentName:"ul"},"Last modified"),(0,l.kt)("li",{parentName:"ul"},"Storage class"),(0,l.kt)("li",{parentName:"ul"},"ETag")),(0,l.kt)("p",null,"Additionally, set ",(0,l.kt)("inlineCode",{parentName:"p"},"Object versions")," to ",(0,l.kt)("inlineCode",{parentName:"p"},"Include all versions"),"."),(0,l.kt)("h3",{id:"potential-internal-reporting-database-structure"},"Potential Internal Reporting Database Structure"),(0,l.kt)("p",null,"The objects needed for managing ORCA internal reconciliation and reporting are\nprovided in detail below."),(0,l.kt)("p",null,"An example schema showing how the objects interact and would be tied together is\nshown below."),(0,l.kt)(i.default,{imageSource:(0,r.Z)("img/Research-Reconciliation-orca-internal-reconciliation-schema.png"),imageAlt:"System Context",zoomInPic:(0,r.Z)("img/zoom-in.svg"),zoomOutPic:(0,r.Z)("img/zoom-out.svg"),resetPic:(0,r.Z)("img/zoom-pan-reset.svg"),mdxType:"MyImage"}),(0,l.kt)("h4",{id:"status-table-reconcile_status"},"Status Table reconcile_status"),(0,l.kt)("p",null,"Reference table for valid status values and status order."),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Attribute Name"),(0,l.kt)("th",{parentName:"tr",align:null},"Data Type"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"),(0,l.kt)("th",{parentName:"tr",align:null},"Notable Items"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"int2")),(0,l.kt)("td",{parentName:"tr",align:null},"Status ID."),(0,l.kt)("td",{parentName:"tr",align:null},"Primary Key")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"value"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Human readable status value."),(0,l.kt)("td",{parentName:"tr",align:null})))),(0,l.kt)("h4",{id:"internal-reconciliation-jobs-table-reconcile_job"},"Internal Reconciliation Jobs Table reconcile_job"),(0,l.kt)("p",null,"This table would capture internal reconciliation job information. Below is a\nsampling of attributes that may be needed. Based on design and implementation,\nadditional attributes may be required. This table, in particular may need additional\nitems for managing jobs."),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Attribute Name"),(0,l.kt)("th",{parentName:"tr",align:null},"Data Type"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"),(0,l.kt)("th",{parentName:"tr",align:null},"Notable Items"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"int2")),(0,l.kt)("td",{parentName:"tr",align:null},"Unique Job ID."),(0,l.kt)("td",{parentName:"tr",align:null},"Primary Key")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"orca_archive_location"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"ORCA S3 Archive bucket the reconciliation targets."),(0,l.kt)("td",{parentName:"tr",align:null},"Location in S3.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"status_id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"int8")),(0,l.kt)("td",{parentName:"tr",align:null},"Current status of the job."),(0,l.kt)("td",{parentName:"tr",align:null},"Generally reflect the stages of reconciliation.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"inventory_creation_time"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"timestamptz")),(0,l.kt)("td",{parentName:"tr",align:null},"Inventory report initiation time from the s3 manifest."),(0,l.kt)("td",{parentName:"tr",align:null},"Cannot be NULL")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"start_time"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"timestamptz")),(0,l.kt)("td",{parentName:"tr",align:null},"Start time of the job."),(0,l.kt)("td",{parentName:"tr",align:null},"Cannot be NULL")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"last_update"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"timestamptz")),(0,l.kt)("td",{parentName:"tr",align:null},"Last time the status was updated."),(0,l.kt)("td",{parentName:"tr",align:null},"Cannot be NULL")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"end_time"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"timestamptz")),(0,l.kt)("td",{parentName:"tr",align:null},"End time of the job."),(0,l.kt)("td",{parentName:"tr",align:null},"NULLABLE column")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"error_message"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Job error message in cases of failure."),(0,l.kt)("td",{parentName:"tr",align:null},"NULLABLE column")))),(0,l.kt)("h4",{id:"s3-inventory-temporary-table-reconcile_s3_object"},"S3 Inventory Temporary Table reconcile_s3_object"),(0,l.kt)("p",null,"This is a temporary object that would store the listing from the S3 bucket for\ncomparison."),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Attribute Name"),(0,l.kt)("th",{parentName:"tr",align:null},"Data Type"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"),(0,l.kt)("th",{parentName:"tr",align:null},"Notable Items"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"job_id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"int8")),(0,l.kt)("td",{parentName:"tr",align:null},"Reconcile job the listing is a part of."),(0,l.kt)("td",{parentName:"tr",align:null},"Many to one relationship with the jobs table.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"orca_archive_location"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"ORCA S3 Archive bucket the file resides in."),(0,l.kt)("td",{parentName:"tr",align:null},"Location in S3.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"key_path"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Key key value from S3 listing."),(0,l.kt)("td",{parentName:"tr",align:null},"Should be able to match to the key_path in the ORCA catalog ",(0,l.kt)("em",{parentName:"td"},"File")," metadata object. Must be unique.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"etag"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"ETag key value from S3 listing."),(0,l.kt)("td",{parentName:"tr",align:null},"Should be able to match to the orca_etag value in the ORCA catalog ",(0,l.kt)("em",{parentName:"td"},"File")," metadata object.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"last_update"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"timestamptz")),(0,l.kt)("td",{parentName:"tr",align:null},"LastModified key value from the S3 listing."),(0,l.kt)("td",{parentName:"tr",align:null},"Should be able to match the last_update value in the ORCA catalog ",(0,l.kt)("em",{parentName:"td"},"File")," metadata object.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"size_in_bytes"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"int8")),(0,l.kt)("td",{parentName:"tr",align:null},"Size key value from the S3 listing."),(0,l.kt)("td",{parentName:"tr",align:null},"Should be able to match the size value in the ORCA catalog ",(0,l.kt)("em",{parentName:"td"},"File")," metadata object.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"storage_class"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"StorageClass key value from the S3 listing."),(0,l.kt)("td",{parentName:"tr",align:null},"May be used as a filter to exclude newly added items by excluding those with a value of ",(0,l.kt)("em",{parentName:"td"},"STANDARD"))))),(0,l.kt)("h4",{id:"internal-reconciliation-reporting-table-orphaned-files-reconcile_orphan_report"},"Internal Reconciliation Reporting Table Orphaned Files reconcile_orphan_report"),(0,l.kt)("p",null,"This table would capture the files that reside in S3 but have no match in the\nORCA catalog. Generally, these files would be deleted or investigated to see if\nitems need to be re-ingested into ORCA.\nNote that entries with a last_update time\nafter or immediately before the job's start_time may not have catalog entries yet\ndue to a slight delay in the catalog population. This should be indicated when\nreporting results."),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Attribute Name"),(0,l.kt)("th",{parentName:"tr",align:null},"Data Type"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"),(0,l.kt)("th",{parentName:"tr",align:null},"Notable Items"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"job_id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"int8")),(0,l.kt)("td",{parentName:"tr",align:null},"Reconcile job the report is a part of."),(0,l.kt)("td",{parentName:"tr",align:null},"FK constraint back to the jobs table with a many to one relationship.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"key_path"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Key key value from S3 listing."),(0,l.kt)("td",{parentName:"tr",align:null})),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"etag"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"ETag key value from S3 listing."),(0,l.kt)("td",{parentName:"tr",align:null})),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"last_update"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"timestamptz")),(0,l.kt)("td",{parentName:"tr",align:null},"LastModified key value from the S3 listing."),(0,l.kt)("td",{parentName:"tr",align:null})),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"size_in_bytes"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"int8")),(0,l.kt)("td",{parentName:"tr",align:null},"Size key value from the S3 listing."),(0,l.kt)("td",{parentName:"tr",align:null})),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"storage_class"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"StorageClass key value from the S3 listing."),(0,l.kt)("td",{parentName:"tr",align:null})))),(0,l.kt)("h4",{id:"internal-reconciliation-reporting-table-s3-missing-reconcile_phantom_report"},"Internal Reconciliation Reporting Table S3 Missing reconcile_phantom_report"),(0,l.kt)("p",null,"This table captures files that have records in the orca catalog, but are missing from S3.\nThese files may have been deleted outside or a proper deletion flow, and may need to have their catalog entries manually cleared.\nNote that any entries with an orca_last_update after the job's\nstart_time may show as an error due to race conditions with the catalog update\nprocess, and should be displayed as such when reporting results."),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Attribute Name"),(0,l.kt)("th",{parentName:"tr",align:null},"Data Type"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"),(0,l.kt)("th",{parentName:"tr",align:null},"Notable Items"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"job_id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"int8")),(0,l.kt)("td",{parentName:"tr",align:null},"Reconcile job the report is a part of."),(0,l.kt)("td",{parentName:"tr",align:null},"FK constraint back to the jobs table with a many to one relationship.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"collection_id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Collection ID from the ORCA Collection object the file belongs to."),(0,l.kt)("td",{parentName:"tr",align:null},"From Catalog.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"granule_id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Granule ID from the ORCA Granule object the file belongs to."),(0,l.kt)("td",{parentName:"tr",align:null},"From Catalog.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"file_name"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"File name from the ORCA File object the file belongs to."),(0,l.kt)("td",{parentName:"tr",align:null},"From Catalog.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"key_path"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Key path that includes the file name from the ORCA File object the file belongs to."),(0,l.kt)("td",{parentName:"tr",align:null},"From Catalog.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"orca_etag"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Etag value from the ORCA File object the file belongs to."),(0,l.kt)("td",{parentName:"tr",align:null},"From Catalog.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"orca_last_update"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"timestamptz")),(0,l.kt)("td",{parentName:"tr",align:null},"Last Update value from the ORCA File object the file belongs to."),(0,l.kt)("td",{parentName:"tr",align:null},"From Catalog.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"orca_size"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"int8")),(0,l.kt)("td",{parentName:"tr",align:null},"Size value from the ORCA File object the file belongs to."),(0,l.kt)("td",{parentName:"tr",align:null},"From Catalog.")))),(0,l.kt)("h4",{id:"internal-reconciliation-reporting-table-catalog-missing-or-mismatches-reconcile_mismatch_report"},"Internal Reconciliation Reporting Table Catalog Missing or Mismatches reconcile_mismatch_report"),(0,l.kt)("p",null,"This table would capture the discrepancies for reporting out to the operators\nabout files that are missing from ORCA S3 or have different metadata values than\nwhat is expected.\nNote that any entries with an orca_last_update after the job's\nstart_time may show as an error due to race conditions with the catalog update\nprocess, and should be displayed as such when reporting results."),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Attribute Name"),(0,l.kt)("th",{parentName:"tr",align:null},"Data Type"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"),(0,l.kt)("th",{parentName:"tr",align:null},"Notable Items"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"job_id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"int8")),(0,l.kt)("td",{parentName:"tr",align:null},"Reconcile job the report is a part of."),(0,l.kt)("td",{parentName:"tr",align:null},"FK constraint back to the jobs table with a many to one relationship.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"collection_id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Collection ID from the ORCA Collection object the file belongs to."),(0,l.kt)("td",{parentName:"tr",align:null},"From Catalog.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"granule_id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Granule ID from the ORCA Granule object the file belongs to."),(0,l.kt)("td",{parentName:"tr",align:null},"From Catalog.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"file_name"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"File name from the ORCA File object the file belongs to."),(0,l.kt)("td",{parentName:"tr",align:null},"From Catalog.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"key_path"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Key path that includes the file name from the ORCA File object the file belongs to."),(0,l.kt)("td",{parentName:"tr",align:null},"From Catalog.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"orca_etag"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Etag value from the ORCA File object the file belongs to."),(0,l.kt)("td",{parentName:"tr",align:null},"From Catalog.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"s3_etag"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"ETag key value from S3 listing."),(0,l.kt)("td",{parentName:"tr",align:null})),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"orca_last_update"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"timestamptz")),(0,l.kt)("td",{parentName:"tr",align:null},"Last Update value from the ORCA File object the file belongs to."),(0,l.kt)("td",{parentName:"tr",align:null},"From Catalog.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"s3_last_update"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"timestamptz")),(0,l.kt)("td",{parentName:"tr",align:null},"LastModified key value from the S3 listing."),(0,l.kt)("td",{parentName:"tr",align:null})),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"orca_size_in_bytes"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"int8")),(0,l.kt)("td",{parentName:"tr",align:null},"Size value from the ORCA File object the file belongs to."),(0,l.kt)("td",{parentName:"tr",align:null},"From Catalog.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"s3_size_in_bytes"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"int8")),(0,l.kt)("td",{parentName:"tr",align:null},"Size key value from the S3 listing."),(0,l.kt)("td",{parentName:"tr",align:null})),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"discrepancy_type"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},'Type of discrepancy encountered like "value x mismatch"'),(0,l.kt)("td",{parentName:"tr",align:null})))),(0,l.kt)("h2",{id:"open-questions-yet-to-be-answered"},"Open Questions yet to be answered"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"What is the proper date to use when receiving a date range from Cumulus for a reconciliation report?"),(0,l.kt)("li",{parentName:"ul"},"Should granule acquisition date be a part of the metadata?"),(0,l.kt)("li",{parentName:"ul"},"Should optional identified attributes be added an populated now or should we start with the minimum needed?"),(0,l.kt)("li",{parentName:"ul"},"Is GraphQL a good replacement for the current SQS - Lambda architecture?")),(0,l.kt)("h2",{id:"additional-artifacts-from-the-research"},"Additional Artifacts from the Research"),(0,l.kt)("p",null,"As part of the research, additional artifacts were created in order to help speed\nalong prototyping and design. Information and instructions on the artifacts are\nprovided below."),(0,l.kt)("h3",{id:"aqua-data-studio-erd-file"},"Aqua Data Studio ERD File"),(0,l.kt)("p",null,"An entity relationship diagram (ERD) was created in ",(0,l.kt)("a",{parentName:"p",href:"https://www.aquafold.com/aquadatastudio"},"Aqua Data Studio (ADS)"),".\nThe ERD provides table, constraint, and reference information for the various\nobjects in the PostgreSQL database used by ORCA. The ERD diagram can be used\nfor development and scripting as well as a way to visualize object interactions.\nThe ADS ERD for ORCA can be downloaded ",(0,l.kt)("a",{href:(0,r.Z)("files/ads_orca_schema.xed"),target:"_blank",download:!0},"here"),"."),(0,l.kt)("h3",{id:"schema-install-sql-scripts"},"Schema Install SQL Scripts"),(0,l.kt)("p",null,"In order to quickly prototype, two SQL install scripts were created. The scripts\ninstall the ORCA inventory catalog and the internal reconciliation tables respectively.\nThe following preconditions are expected before the install scripts are run."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"The latest ORCA schema is installed in PostgreSQL (v3.x)"),(0,l.kt)("li",{parentName:"ul"},"The user is logged into the orca database as the admin user to run the script.")),(0,l.kt)("p",null,"The ORCA inventory catalog build script is available for download ",(0,l.kt)("a",{href:(0,r.Z)("files/build_orca_inventory.sql"),target:"_blank",download:!0},"here"),"."),(0,l.kt)("p",null,"The ORCA internal reconciliation tables build script is available for download ",(0,l.kt)("a",{href:(0,r.Z)("files/build_orca_reconcile.sql"),target:"_blank",download:!0},"here"),"."),(0,l.kt)("h2",{id:"notes-from-orca-schema-refinement-research"},"Notes from ORCA schema refinement research"),(0,l.kt)("p",null,"As part of the research, some refinements were made to the ORCA inventory catalog\nschema. This includes refinements to the ",(0,l.kt)("inlineCode",{parentName:"p"},"granules")," table and removal of the\n",(0,l.kt)("inlineCode",{parentName:"p"},"provider_collection_xref")," table and the relationship between provider and\ncollection."),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"execution_id")," has been added for helping with logging and tracing."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"cumulus_create_time")," has been added for time based filtering with cumulus. The cumulus ",(0,l.kt)("inlineCode",{parentName:"li"},"createdAt")," time will be a consistent time source between catalogs"),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"provider_id")," has been added to create a relationship between granule and provider."),(0,l.kt)("li",{parentName:"ul"},(0,l.kt)("inlineCode",{parentName:"li"},"archive_location")," has been removed since ",(0,l.kt)("inlineCode",{parentName:"li"},"orca_archive_location")," already exists in the ",(0,l.kt)("inlineCode",{parentName:"li"},"files")," table.")),(0,l.kt)("h4",{id:"refined-granule-metadata-object"},"Refined Granule Metadata Object"),(0,l.kt)("table",null,(0,l.kt)("thead",{parentName:"table"},(0,l.kt)("tr",{parentName:"thead"},(0,l.kt)("th",{parentName:"tr",align:null},"Attribute Name"),(0,l.kt)("th",{parentName:"tr",align:null},"Data Type"),(0,l.kt)("th",{parentName:"tr",align:null},"Description"),(0,l.kt)("th",{parentName:"tr",align:null},"Notable Items"))),(0,l.kt)("tbody",{parentName:"table"},(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"cumulus_granule_id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"granuleId that is provided by Cumulus."),(0,l.kt)("td",{parentName:"tr",align:null},"Must be unique per collectionId")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"provider_id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"providerId that is provided by Cumulus"),(0,l.kt)("td",{parentName:"tr",align:null},"Ties a granule to a provider.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"collection_id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"collectionId that is provided by Cumulus"),(0,l.kt)("td",{parentName:"tr",align:null},"Ties a granule to a collection. The collectionId and granuleId combination must be unique.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"execution_id"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"string")),(0,l.kt)("td",{parentName:"tr",align:null},"Step function execution ID from AWS."),(0,l.kt)("td",{parentName:"tr",align:null},"Unique ID automatically generated by AWS")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"cumulus_create_time"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"timestamp")),(0,l.kt)("td",{parentName:"tr",align:null},"createdAt time provided by Cumulus when the granule was ingested."),(0,l.kt)("td",{parentName:"tr",align:null},"This is the Cumulus archive time used for time based comparisons.")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"ingest_time"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"timestamp")),(0,l.kt)("td",{parentName:"tr",align:null},"Date and time in UTC that the data was originally ingested into ORCA"),(0,l.kt)("td",{parentName:"tr",align:null},"None")),(0,l.kt)("tr",{parentName:"tbody"},(0,l.kt)("td",{parentName:"tr",align:null},"last_update"),(0,l.kt)("td",{parentName:"tr",align:null},(0,l.kt)("inlineCode",{parentName:"td"},"timestamp")),(0,l.kt)("td",{parentName:"tr",align:null},"Date and time in UTC that information was updated."),(0,l.kt)("td",{parentName:"tr",align:null},"Potential time filter for Cumulus reconciliation.")))),(0,l.kt)("admonition",{type:"note"},(0,l.kt)("p",{parentName:"admonition"},"  It is recommended to add tags for ",(0,l.kt)("inlineCode",{parentName:"p"},"hash")," and ",(0,l.kt)("inlineCode",{parentName:"p"},"hash_type")," when the values are available to files that get copied over to S3 bucket.")),(0,l.kt)("h3",{id:"refined-erd-file--sql-script"},"Refined ERD File & SQL script"),(0,l.kt)("p",null,"The refined ADS ERD for ORCA can be downloaded ",(0,l.kt)("a",{href:(0,r.Z)("files/ads_orca_schema_refined.xed"),target:"_blank",download:!0},"here"),". The refined ORCA inventory catalog build script is available for download ",(0,l.kt)("a",{href:(0,r.Z)("files/build_orca_inventory_refined.sql"),target:"_blank",download:!0},"here"),"."),(0,l.kt)("h3",{id:"addressing-open-questions"},"Addressing open questions"),(0,l.kt)("ul",null,(0,l.kt)("li",{parentName:"ul"},"What is the proper date to use when receiving a date range from Cumulus for a reconciliation report?",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"After discussion with the Cumulus team, we have decided to use ",(0,l.kt)("inlineCode",{parentName:"li"},"cumulus_create_time"),"\nwhich is passed by Cumulus ",(0,l.kt)("inlineCode",{parentName:"li"},"createdAt")," key in the CMA Message containing the timestamp that the granule began ingest of the granule into Cumulus.\nThis timestamp will be used to filter results for Cumulus when asking for ORCA catalog inventory information and will be captured in the Cumulus ",(0,l.kt)("inlineCode",{parentName:"li"},"granules")," table."))),(0,l.kt)("li",{parentName:"ul"},"Should granule acquisition date be a part of the metadata?",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"At this time, we are not going to include granule acquisition date since we cannot get it natively from Cumulus but might add it in the future."))),(0,l.kt)("li",{parentName:"ul"},"Should optional identified attributes be added and populated now or should we start with the minimum needed?",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"Added step function's ",(0,l.kt)("inlineCode",{parentName:"li"},"execution_id")," to the ",(0,l.kt)("inlineCode",{parentName:"li"},"granules")," table. "))),(0,l.kt)("li",{parentName:"ul"},"Is GraphQL a good replacement for the current SQS - Lambda architecture?",(0,l.kt)("ul",{parentName:"li"},(0,l.kt)("li",{parentName:"ul"},"Based on the research performed and prototype created on GraphQL, it is not currently a good replacement due to the lack of documentation which makes implementation difficult. Check ",(0,l.kt)("a",{parentName:"li",href:"https://nasa.github.io/cumulus-orca/docs/developer/research/research-graphql"},"GraphQL research notes")," for more information.")))))}h.isMDXComponent=!0},4079:(e,t,a)=>{a.r(t),a.d(t,{assets:()=>m,contentTitle:()=>d,default:()=>h,frontMatter:()=>o,metadata:()=>s,toc:()=>u});var n=a(7462),l=a(7294),i=a(3905),r=a(6126);const o={},d=void 0,s={unversionedId:"templates/pan-zoom-image",id:"templates/pan-zoom-image",title:"pan-zoom-image",description:"The image below can be panned and zoomed using your mouse or the provided buttons.",source:"@site/docs/templates/pan-zoom-image.mdx",sourceDirName:"templates",slug:"/templates/pan-zoom-image",permalink:"/cumulus-orca/docs/templates/pan-zoom-image",draft:!1,editUrl:"https://github.com/nasa/cumulus-orca/edit/develop/website/docs/templates/pan-zoom-image.mdx",tags:[],version:"current",frontMatter:{}},m={},u=[],p={toc:u},c="wrapper";function h(e){let{components:t,...a}=e;return(0,i.kt)(c,(0,n.Z)({},p,a,{components:t,mdxType:"MDXLayout"}),(0,i.kt)("admonition",{title:"Interactive Image",type:"note"},(0,i.kt)("p",{parentName:"admonition"},"The image below can be panned and zoomed using your mouse or the provided buttons.\nTo reset the image to the original size on the page click ",(0,i.kt)("img",{width:"12px",height:"12px",src:a.resetPic,alt:"Reset Image"}),".\nIf you wish to view the full image on a separate page, click this ",(0,i.kt)("a",{href:a.imageSource,target:"_blank",rel:"noopener noreferrer"},"link"),".")),(0,i.kt)(r.d$,{defaultScale:1,mdxType:"TransformWrapper"},(e=>{let{zoomIn:t,zoomOut:n,resetTransform:o,...d}=e;return(0,i.kt)(l.Fragment,null,(0,i.kt)("div",{className:"tools"},(0,i.kt)("button",{onClick:()=>t()},(0,i.kt)("img",{width:"15px",height:"15px",src:a.zoomInPic,alt:"Zoom In"})),(0,i.kt)("button",{onClick:()=>n()},(0,i.kt)("img",{width:"15px",height:"15px",src:a.zoomOutPic,alt:"Zoom Out"})),(0,i.kt)("button",{onClick:()=>o()},(0,i.kt)("img",{width:"15px",height:"15px",src:a.resetPic,alt:"Reset Image"}))),(0,i.kt)(r.Uv,{mdxType:"TransformComponent"},(0,i.kt)("img",{src:a.imageSource,alt:a.imageAlt})))})))}h.isMDXComponent=!0}}]);